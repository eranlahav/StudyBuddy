---
phase: 01-profile-foundation
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - store.tsx
  - hooks/useLearnerProfile.ts
  - hooks/index.ts
autonomous: true

must_haves:
  truths:
    - "Profile updates automatically after each quiz without user action"
    - "useLearnerProfile hook provides profile state and loading status"
    - "Profile subscription cleans up on component unmount"
  artifacts:
    - path: "store.tsx"
      provides: "Profile signal integration in addSession"
      contains: "processQuizSignal"
    - path: "hooks/useLearnerProfile.ts"
      provides: "React hook for profile state management"
      exports: ["useLearnerProfile"]
    - path: "hooks/index.ts"
      provides: "Hook re-exports"
      contains: "useLearnerProfile"
  key_links:
    - from: "store.tsx"
      to: "services/signalService.ts"
      via: "processQuizSignal import and call"
      pattern: "processQuizSignal\\(session"
    - from: "hooks/useLearnerProfile.ts"
      to: "services/profileService.ts"
      via: "subscribeToProfile import"
      pattern: "import.*subscribeToProfile"
---

<objective>
Integrate profile updates into the store's addSession flow and create a hook for components to access profile data.

Purpose: This connects the profile backend to React - store.tsx triggers profile updates on quiz completion, while useLearnerProfile hook enables UI components to display profile data with real-time updates.

Output: Modified store.tsx with profile signal processing, and new useLearnerProfile hook for UI integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-profile-foundation/01-RESEARCH.md

# Prior plan outputs
@.planning/phases/01-profile-foundation/01-01-SUMMARY.md
@.planning/phases/01-profile-foundation/01-02-SUMMARY.md

# Key existing files
@store.tsx
@hooks/useQuizSession.ts
@hooks/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate processQuizSignal into store.tsx</name>
  <files>store.tsx</files>
  <action>
Modify store.tsx to call processQuizSignal after saving a quiz session.

1. Add import at the top with other service imports:
```typescript
import {
  // ... existing imports
  processQuizSignal  // Add this
} from './services';
```

2. Modify the addSession callback (around line 401) to add fire-and-forget profile update:

Find the existing addSession callback:
```typescript
const addSession = useCallback(async (sessionData: Omit<StudySession, 'familyId'>) => {
  if (!family) {
    throw new Error('Must be logged in to add a session');
  }

  const session: StudySession = {
    ...sessionData,
    familyId: family.id
  };

  // Add the session
  await addSessionService(session);

  // Update child stats
  const child = state.children.find(c => c.id === session.childId);
  if (child) {
    const pointsEarned = session.score * 10;
    await awardPoints(child.id, child.stars, child.streak, pointsEarned);
  }
}, [family, state.children]);
```

Replace with:
```typescript
const addSession = useCallback(async (sessionData: Omit<StudySession, 'familyId'>) => {
  if (!family) {
    throw new Error('Must be logged in to add a session');
  }

  const session: StudySession = {
    ...sessionData,
    familyId: family.id
  };

  // Add the session
  await addSessionService(session);

  // Update child stats
  const child = state.children.find(c => c.id === session.childId);
  if (child) {
    const pointsEarned = session.score * 10;
    await awardPoints(child.id, child.stars, child.streak, pointsEarned);

    // Fire-and-forget: Update learner profile with quiz signal
    // This runs in background and doesn't block the UI
    processQuizSignal(session, child).catch(err => {
      // Error already logged in signalService - just swallow here
      // Profile update failure should never break quiz flow
    });
  }
}, [family, state.children]);
```

Important: The processQuizSignal call is NOT awaited - this is intentional fire-and-forget pattern. The catch() ensures the promise rejection doesn't cause unhandled promise warnings.
  </action>
  <verify>
1. Run `npx tsc --noEmit` - no TypeScript errors
2. processQuizSignal is called after awardPoints
3. The call is NOT awaited (fire-and-forget pattern)
  </verify>
  <done>store.tsx calls processQuizSignal after session save with fire-and-forget pattern</done>
</task>

<task type="auto">
  <name>Task 2: Create useLearnerProfile Hook</name>
  <files>hooks/useLearnerProfile.ts</files>
  <action>
Create new file hooks/useLearnerProfile.ts for profile state management:

```typescript
/**
 * useLearnerProfile Hook
 *
 * Provides access to a child's learner profile with real-time updates.
 * Handles subscription lifecycle, loading states, and error handling.
 *
 * Usage:
 *   const { profile, isLoading, error } = useLearnerProfile(childId);
 */

import { useState, useEffect, useCallback } from 'react';
import { LearnerProfile, TopicMastery, MasteryLevel, getMasteryLevel } from '../types';
import { subscribeToProfile, getProfile, bootstrapProfile } from '../services';
import { logger } from '../lib';

export interface UseLearnerProfileOptions {
  /** If true, don't bootstrap from sessions (for testing) */
  skipBootstrap?: boolean;
}

export interface UseLearnerProfileReturn {
  /** Current learner profile (null if loading or not found) */
  profile: LearnerProfile | null;

  /** True while initial load is in progress */
  isLoading: boolean;

  /** Error if subscription failed */
  error: Error | null;

  /** Manually refresh profile (rarely needed due to real-time updates) */
  refresh: () => Promise<void>;

  /** Get topics by mastery level */
  getTopicsByMastery: (level: MasteryLevel) => TopicMastery[];

  /** Get profile confidence level based on data quantity */
  getConfidenceLevel: () => 'low' | 'medium' | 'high';
}

/**
 * Hook to access learner profile with real-time updates
 *
 * @param childId - Child ID to get profile for
 * @param options - Configuration options
 */
export function useLearnerProfile(
  childId: string | undefined,
  options: UseLearnerProfileOptions = {}
): UseLearnerProfileReturn {
  const [profile, setProfile] = useState<LearnerProfile | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<Error | null>(null);

  // Subscribe to profile changes
  useEffect(() => {
    if (!childId) {
      setProfile(null);
      setIsLoading(false);
      return;
    }

    setIsLoading(true);
    setError(null);

    logger.debug('useLearnerProfile: Subscribing', { childId });

    const unsubscribe = subscribeToProfile(
      childId,
      (data) => {
        setProfile(data);
        setIsLoading(false);
        logger.debug('useLearnerProfile: Profile received', {
          childId,
          hasProfile: !!data,
          topicsCount: data ? Object.keys(data.topicMastery).length : 0
        });
      },
      (err) => {
        setError(err);
        setIsLoading(false);
        logger.error('useLearnerProfile: Subscription error', { childId }, err);
      }
    );

    return () => {
      logger.debug('useLearnerProfile: Unsubscribing', { childId });
      unsubscribe();
    };
  }, [childId]);

  // Manual refresh (rarely needed)
  const refresh = useCallback(async () => {
    if (!childId) return;

    try {
      setIsLoading(true);
      const freshProfile = await getProfile(childId);
      setProfile(freshProfile);
    } catch (err) {
      setError(err as Error);
    } finally {
      setIsLoading(false);
    }
  }, [childId]);

  // Get topics filtered by mastery level
  const getTopicsByMastery = useCallback((level: MasteryLevel): TopicMastery[] => {
    if (!profile) return [];

    return Object.values(profile.topicMastery).filter(
      topic => getMasteryLevel(topic.pKnown) === level
    );
  }, [profile]);

  // Get confidence level based on data quantity
  const getConfidenceLevel = useCallback((): 'low' | 'medium' | 'high' => {
    if (!profile) return 'low';

    const totalQuestions = profile.totalQuestions;

    if (totalQuestions < 20) {
      return 'low';
    } else if (totalQuestions < 50) {
      return 'medium';
    } else {
      return 'high';
    }
  }, [profile]);

  return {
    profile,
    isLoading,
    error,
    refresh,
    getTopicsByMastery,
    getConfidenceLevel
  };
}

/**
 * Get Hebrew message for confidence level
 */
export function getConfidenceMessage(level: 'low' | 'medium' | 'high'): string {
  switch (level) {
    case 'low':
      return 'בונים פרופיל אישי... נצבור עוד מידע ב-2-3 תרגולים';
    case 'medium':
      return 'הפרופיל האישי מתחיל להיות מדויק';
    case 'high':
      return 'פרופיל אישי מפורט ומדויק';
  }
}
```
  </action>
  <verify>Run `npx tsc --noEmit` - no TypeScript errors</verify>
  <done>hooks/useLearnerProfile.ts exists with useLearnerProfile hook and getConfidenceMessage utility</done>
</task>

<task type="auto">
  <name>Task 3: Update Hooks Index</name>
  <files>hooks/index.ts</files>
  <action>
Add exports for useLearnerProfile to hooks/index.ts.

Add at the end of the file:

```typescript
// Learner profile
export { useLearnerProfile, getConfidenceMessage } from './useLearnerProfile';
export type {
  UseLearnerProfileOptions,
  UseLearnerProfileReturn
} from './useLearnerProfile';
```
  </action>
  <verify>Can import { useLearnerProfile } from './hooks'</verify>
  <done>useLearnerProfile and types exported from hooks/index.ts</done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit` passes with no errors
2. store.tsx imports and calls processQuizSignal in addSession
3. processQuizSignal is NOT awaited (fire-and-forget confirmed)
4. useLearnerProfile hook is importable from hooks
5. Hook handles subscription cleanup on unmount
</verification>

<success_criteria>
- Quiz completion triggers profile update automatically (no user action needed)
- Profile updates don't block UI (fire-and-forget pattern in store.tsx)
- useLearnerProfile provides profile, isLoading, error states
- Hook has getTopicsByMastery helper for filtering by mastery level
- Hook has getConfidenceLevel helper for profile completeness indicator
- Subscription cleanup prevents memory leaks
</success_criteria>

<output>
After completion, create `.planning/phases/01-profile-foundation/01-03-SUMMARY.md`
</output>
