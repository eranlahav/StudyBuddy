---
phase: 01-profile-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - types.ts
  - lib/errors.ts
  - lib/learnerModel.ts
  - lib/index.ts
autonomous: true

must_haves:
  truths:
    - "LearnerProfile and TopicMastery types are importable from types.ts"
    - "BKT algorithm calculates correct mastery probability updates"
    - "ProfileUpdateError class exists with Hebrew user message"
  artifacts:
    - path: "types.ts"
      provides: "LearnerProfile, TopicMastery, BKTParams interfaces"
      contains: "interface LearnerProfile"
    - path: "lib/learnerModel.ts"
      provides: "BKT algorithm implementation"
      exports: ["updateBKT", "getBKTParams", "recommendDifficulty"]
    - path: "lib/errors.ts"
      provides: "ProfileUpdateError class"
      contains: "export class ProfileUpdateError"
  key_links:
    - from: "lib/learnerModel.ts"
      to: "types.ts"
      via: "import { BKTParams, GradeLevel }"
      pattern: "import.*BKTParams.*from"
---

<objective>
Create the foundational types and BKT (Bayesian Knowledge Tracing) algorithm for the learner profile system.

Purpose: Establish the data structures and core algorithm that will power adaptive learning - without these, no profile tracking or intelligent recommendations are possible.

Output: TypeScript interfaces for profiles, BKT parameter types, and pure functions implementing the Bayesian update algorithm.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-profile-foundation/01-RESEARCH.md

# Key existing files
@types.ts
@lib/errors.ts
@lib/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Profile Types to types.ts</name>
  <files>types.ts</files>
  <action>
Add the following interfaces to types.ts after the existing Evaluation types section:

```typescript
// ==========================================
// LEARNER PROFILE TYPES
// ==========================================

/**
 * BKT (Bayesian Knowledge Tracing) parameters
 * Controls how mastery probability updates based on responses
 */
export interface BKTParams {
  pInit: number;   // Initial mastery probability (0.1-0.3)
  pLearn: number;  // Learning rate per question (0.15-0.3)
  pGuess: number;  // Probability of correct guess (0.2-0.25)
  pSlip: number;   // Probability of slip/mistake (0.05-0.15)
}

/**
 * Mastery tracking for a single topic
 */
export interface TopicMastery {
  // Identification
  topic: string;
  subjectId: string;

  // BKT state
  pKnown: number;              // 0-1, current mastery probability
  attempts: number;            // Total questions answered

  // Performance aggregates
  correctCount: number;
  incorrectCount: number;
  averageTime: number;         // Seconds per question (Phase 4+)

  // Trend detection
  recentTrend: 'improving' | 'stable' | 'declining';
  performanceWindow: number[]; // Last 10 attempts (1=correct, 0=incorrect)

  // Timestamps
  firstAttempt: number;
  lastAttempt: number;

  // Extensible (Phase 4+)
  speed?: number;              // Optional: questions/minute
  consistency?: number;        // Optional: 1 - variance
  questionTypeBreakdown?: Record<string, number>;  // Optional
}

/**
 * Complete learner profile for a child
 * Stored at /children/{childId}/learnerProfile/main
 */
export interface LearnerProfile {
  // Identity
  childId: string;
  familyId: string;

  // Topic-level tracking (map for O(1) lookups)
  topicMastery: Record<string, TopicMastery>;

  // Global metadata
  totalQuizzes: number;
  totalQuestions: number;
  lastUpdated: number;

  // Version for schema migrations
  version: number;  // Start at 1
}

/**
 * Mastery level categories for UI display
 */
export type MasteryLevel = 'mastered' | 'learning' | 'weak';

/**
 * Get mastery level from pKnown probability
 */
export function getMasteryLevel(pKnown: number): MasteryLevel {
  if (pKnown >= 0.8) return 'mastered';
  if (pKnown >= 0.5) return 'learning';
  return 'weak';
}
```

Important: Place these after the Evaluation types section (around line 265) with clear section header comment.
  </action>
  <verify>Run `npx tsc --noEmit` - should pass with no errors related to new types</verify>
  <done>LearnerProfile, TopicMastery, BKTParams, MasteryLevel types exist in types.ts and are importable</done>
</task>

<task type="auto">
  <name>Task 2: Add ProfileUpdateError to lib/errors.ts</name>
  <files>lib/errors.ts</files>
  <action>
Add ProfileUpdateError class to lib/errors.ts after the DatabaseError class (around line 104):

```typescript
/**
 * Error thrown when profile update operations fail
 */
export class ProfileUpdateError extends AppError {
  constructor(message: string, options: { cause?: Error } = {}) {
    super(
      message,
      'לא הצלחנו לעדכן את הפרופיל. הנתונים נשמרו בכל מקרה.',
      { ...options, recoverable: true }
    );
    this.name = 'ProfileUpdateError';
  }
}
```

Then add the export to lib/index.ts in the error handling section:
```typescript
export {
  // ... existing exports
  ProfileUpdateError,
  // ... rest of exports
} from './errors';
```
  </action>
  <verify>Run `npx tsc --noEmit` - no errors; can import ProfileUpdateError from lib</verify>
  <done>ProfileUpdateError class exists with Hebrew user message and is exported from lib/index.ts</done>
</task>

<task type="auto">
  <name>Task 3: Create BKT Algorithm in lib/learnerModel.ts</name>
  <files>lib/learnerModel.ts, lib/index.ts</files>
  <action>
Create new file lib/learnerModel.ts with the BKT (Bayesian Knowledge Tracing) algorithm:

```typescript
/**
 * Learner Model - Bayesian Knowledge Tracing Implementation
 *
 * Implements BKT algorithm for probabilistic skill tracking.
 * Based on Corbett & Anderson (1994) with grade-specific parameters.
 *
 * Key concepts:
 * - pKnown: Probability student has mastered the skill (0-1)
 * - pLearn: Probability of learning from each question
 * - pGuess: Probability of correct answer when skill not known
 * - pSlip: Probability of incorrect answer when skill is known
 */

import { BKTParams, GradeLevel, DifficultyLevel } from '../types';

/**
 * Default BKT parameters by grade band
 * Based on educational research + Khan Academy calibration
 */
export const BKT_DEFAULTS: Record<string, BKTParams> = {
  'grades_1_3': {
    pInit: 0.10,   // Start low (most material new)
    pLearn: 0.30,  // Learn quickly (foundational skills)
    pGuess: 0.25,  // 4 options = 25% theoretical
    pSlip: 0.15    // Higher slip (developing focus)
  },
  'grades_4_6': {
    pInit: 0.20,   // Some prior knowledge
    pLearn: 0.20,  // Steady learning rate
    pGuess: 0.20,  // Slightly below theoretical
    pSlip: 0.10    // Improved attention
  },
  'grades_7_8': {
    pInit: 0.25,   // More background
    pLearn: 0.15,  // Slower (complex material)
    pGuess: 0.18,  // Strategic guessing
    pSlip: 0.08    // Mature focus
  }
};

/**
 * Get grade band key from GradeLevel enum
 */
function getGradeBand(grade: GradeLevel): string {
  // Extract grade number from Hebrew string (e.g., "כיתה ד'" -> 4)
  const gradeMap: Record<GradeLevel, number> = {
    [GradeLevel.Grade1]: 1,
    [GradeLevel.Grade2]: 2,
    [GradeLevel.Grade3]: 3,
    [GradeLevel.Grade4]: 4,
    [GradeLevel.Grade5]: 5,
    [GradeLevel.Grade6]: 6,
    [GradeLevel.Grade7]: 7,
    [GradeLevel.Grade8]: 8
  };

  const gradeNum = gradeMap[grade] ?? 4; // Default to grade 4 if unknown

  if (gradeNum <= 3) return 'grades_1_3';
  if (gradeNum <= 6) return 'grades_4_6';
  return 'grades_7_8';
}

/**
 * Get grade-appropriate BKT parameters
 */
export function getBKTParams(grade: GradeLevel): BKTParams {
  const band = getGradeBand(grade);
  return BKT_DEFAULTS[band] || BKT_DEFAULTS['grades_4_6'];
}

/**
 * Update mastery probability using Bayesian Knowledge Tracing
 *
 * @param pKnown - Current mastery probability (0-1)
 * @param correct - Did student answer correctly?
 * @param params - BKT parameters (grade-specific)
 * @returns Updated mastery probability (0-1)
 *
 * Formula based on Corbett & Anderson (1994):
 * 1. Update for learning opportunity: P(K) = P(K) + (1-P(K)) * P(Learn)
 * 2. Apply Bayes rule based on observed response
 */
export function updateBKT(
  pKnown: number,
  correct: boolean,
  params: BKTParams
): number {
  const { pLearn, pGuess, pSlip } = params;

  // Update for learning opportunity (happens regardless of answer)
  const pKnownAfterLearning = pKnown + (1 - pKnown) * pLearn;

  // Conditional probabilities
  const pCorrectIfKnown = 1 - pSlip;
  const pCorrectIfUnknown = pGuess;

  // Apply Bayes rule
  let pKnownPosterior: number;

  if (correct) {
    // P(Known | Correct) using Bayes rule
    const numerator = pKnownAfterLearning * pCorrectIfKnown;
    const denominator =
      pKnownAfterLearning * pCorrectIfKnown +
      (1 - pKnownAfterLearning) * pCorrectIfUnknown;
    pKnownPosterior = numerator / denominator;
  } else {
    // P(Known | Incorrect) using Bayes rule
    const numerator = pKnownAfterLearning * (1 - pCorrectIfKnown);
    const denominator =
      pKnownAfterLearning * (1 - pCorrectIfKnown) +
      (1 - pKnownAfterLearning) * (1 - pCorrectIfUnknown);
    pKnownPosterior = numerator / denominator;
  }

  // Clamp to [0, 1] to handle numerical edge cases
  return Math.max(0, Math.min(1, pKnownPosterior));
}

/**
 * Recommend difficulty level based on current mastery
 */
export function recommendDifficulty(pKnown: number): DifficultyLevel {
  if (pKnown < 0.4) {
    return 'easy';
  } else if (pKnown < 0.7) {
    return 'medium';
  } else {
    return 'hard';
  }
}

/**
 * Calculate trend from performance window
 * Requires at least 6 attempts for meaningful comparison
 */
export function calculateTrend(
  performanceWindow: number[]
): 'improving' | 'stable' | 'declining' {
  if (performanceWindow.length < 6) {
    return 'stable';
  }

  // Compare last 3 vs previous 3
  const recent = performanceWindow.slice(-3).reduce((a, b) => a + b, 0);
  const previous = performanceWindow.slice(-6, -3).reduce((a, b) => a + b, 0);

  if (recent > previous + 1) {
    return 'improving';
  } else if (recent < previous - 1) {
    return 'declining';
  }
  return 'stable';
}
```

Then update lib/index.ts to export the learner model functions:

```typescript
// Add at the end of lib/index.ts

// Learner Model (BKT)
export {
  updateBKT,
  getBKTParams,
  recommendDifficulty,
  calculateTrend,
  BKT_DEFAULTS
} from './learnerModel';
```
  </action>
  <verify>
1. Run `npx tsc --noEmit` - no TypeScript errors
2. Can import { updateBKT, getBKTParams } from lib
3. BKT algorithm returns values between 0 and 1
  </verify>
  <done>lib/learnerModel.ts exists with updateBKT, getBKTParams, recommendDifficulty, calculateTrend functions; all exported from lib/index.ts</done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit` passes with no errors
2. Types are importable: `import { LearnerProfile, TopicMastery, BKTParams } from './types'`
3. BKT functions are importable: `import { updateBKT, getBKTParams } from './lib'`
4. ProfileUpdateError is importable: `import { ProfileUpdateError } from './lib'`
</verification>

<success_criteria>
- LearnerProfile, TopicMastery, BKTParams interfaces defined in types.ts
- getMasteryLevel utility function works correctly (pKnown >= 0.8 -> 'mastered', >= 0.5 -> 'learning', else 'weak')
- BKT algorithm returns values in [0, 1] range
- ProfileUpdateError has Hebrew userMessage for graceful error display
- All new code passes TypeScript compilation
</success_criteria>

<output>
After completion, create `.planning/phases/01-profile-foundation/01-01-SUMMARY.md`
</output>
