---
phase: 01-profile-foundation
plan: 04
type: execute
wave: 4
depends_on: ["01-03"]
files_modified:
  - pages/ChildDetails/AnalysisTab.tsx
  - pages/ChildDetails/types.ts
autonomous: false

must_haves:
  truths:
    - "Parent can view topic mastery list in AnalysisTab"
    - "Each topic shows mastery probability, practice count, and last practice date"
    - "Topics are categorized as mastered/learning/weak with visual indicators"
  artifacts:
    - path: "pages/ChildDetails/AnalysisTab.tsx"
      provides: "Topic mastery display UI"
      contains: "TopicMasterySection"
    - path: "pages/ChildDetails/types.ts"
      provides: "Updated type definitions for profile props"
      contains: "profile"
  key_links:
    - from: "pages/ChildDetails/AnalysisTab.tsx"
      to: "hooks/useLearnerProfile.ts"
      via: "prop drilling from parent"
      pattern: "profile.*LearnerProfile"
---

<objective>
Add topic mastery display to the AnalysisTab showing which topics are mastered/learning/weak.

Purpose: This delivers the visible user value - parents can now see their child's topic-level mastery with BKT-calculated probabilities, practice counts, and trends. This is the UI surface of the entire profile system.

Output: Enhanced AnalysisTab with TopicMasterySection component showing color-coded topic cards with mastery data.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-profile-foundation/01-RESEARCH.md

# Prior plan outputs
@.planning/phases/01-profile-foundation/01-01-SUMMARY.md
@.planning/phases/01-profile-foundation/01-02-SUMMARY.md
@.planning/phases/01-profile-foundation/01-03-SUMMARY.md

# Key existing files
@pages/ChildDetails/AnalysisTab.tsx
@pages/ChildDetails/types.ts
@types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update AnalysisTab Types</name>
  <files>pages/ChildDetails/types.ts</files>
  <action>
First, read the existing pages/ChildDetails/types.ts to understand current structure, then add profile-related props.

Add to the AnalysisTabProps interface:
```typescript
// Import at top
import { LearnerProfile } from '../../types';

// Update AnalysisTabProps interface to include profile data
export interface AnalysisTabProps {
  subjects: Subject[];
  sessions: StudySession[];
  // NEW: Profile data for topic mastery display
  profile: LearnerProfile | null;
  profileLoading: boolean;
  profileConfidence: 'low' | 'medium' | 'high';
}
```

If AnalysisTabProps doesn't exist in types.ts, check where it's defined and update there instead.
  </action>
  <verify>Run `npx tsc --noEmit` - AnalysisTabProps includes profile props</verify>
  <done>AnalysisTabProps updated with profile, profileLoading, profileConfidence props</done>
</task>

<task type="auto">
  <name>Task 2: Add TopicMasterySection to AnalysisTab</name>
  <files>pages/ChildDetails/AnalysisTab.tsx</files>
  <action>
Enhance AnalysisTab.tsx with topic mastery display.

1. Add imports at the top:
```typescript
import { Brain, CheckCircle, BookOpen, AlertTriangle, Clock, TrendingUp as TrendIcon, Info } from 'lucide-react';
import { LearnerProfile, TopicMastery, getMasteryLevel, MasteryLevel } from '../../types';
import { formatRelativeDay } from '../../lib';
import { getConfidenceMessage } from '../../hooks';
```

2. Update the component props destructuring:
```typescript
export const AnalysisTab: React.FC<AnalysisTabProps> = ({
  subjects,
  sessions,
  profile,
  profileLoading,
  profileConfidence
}) => {
```

3. Add the TopicMasterySection component after the existing WeaknessesCard component definition (before the export):

```typescript
// --- Topic Mastery Section ---

interface TopicMasteryCardProps {
  mastery: TopicMastery;
  subjectName: string;
}

const TopicMasteryCard = React.memo<TopicMasteryCardProps>(({ mastery, subjectName }) => {
  const level = getMasteryLevel(mastery.pKnown);
  const percentage = Math.round(mastery.pKnown * 100);

  const levelConfig = {
    mastered: {
      bg: 'bg-green-50',
      border: 'border-green-200',
      text: 'text-green-700',
      icon: CheckCircle,
      label: 'נשלט'
    },
    learning: {
      bg: 'bg-blue-50',
      border: 'border-blue-200',
      text: 'text-blue-700',
      icon: BookOpen,
      label: 'בלמידה'
    },
    weak: {
      bg: 'bg-orange-50',
      border: 'border-orange-200',
      text: 'text-orange-700',
      icon: AlertTriangle,
      label: 'לחיזוק'
    }
  };

  const config = levelConfig[level];
  const Icon = config.icon;

  const trendIcon = {
    improving: { icon: TrendIcon, color: 'text-green-500', rotate: '' },
    stable: { icon: TrendIcon, color: 'text-gray-400', rotate: 'rotate-90' },
    declining: { icon: TrendIcon, color: 'text-red-500', rotate: 'rotate-180' }
  };

  const trend = trendIcon[mastery.recentTrend];

  return (
    <div className={`p-4 rounded-xl border ${config.bg} ${config.border}`}>
      <div className="flex justify-between items-start mb-2">
        <div className="flex items-center gap-2">
          <Icon size={18} className={config.text} />
          <span className={`text-xs font-medium ${config.text}`}>{config.label}</span>
        </div>
        <div className="flex items-center gap-1">
          <trend.icon size={14} className={`${trend.color} ${trend.rotate}`} />
        </div>
      </div>

      <h4 className="font-bold text-gray-900 mb-1">{mastery.topic}</h4>
      <p className="text-xs text-gray-500 mb-3">{subjectName}</p>

      {/* Mastery bar */}
      <div className="mb-3">
        <div className="flex justify-between text-xs mb-1">
          <span className="text-gray-600">שליטה</span>
          <span className={`font-bold ${config.text}`}>{percentage}%</span>
        </div>
        <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
          <div
            className={`h-full rounded-full transition-all duration-500 ${
              level === 'mastered' ? 'bg-green-500' :
              level === 'learning' ? 'bg-blue-500' : 'bg-orange-500'
            }`}
            style={{ width: `${percentage}%` }}
          />
        </div>
      </div>

      {/* Stats */}
      <div className="flex justify-between text-xs text-gray-500">
        <span className="flex items-center gap-1">
          <BookOpen size={12} />
          {mastery.attempts} שאלות
        </span>
        <span className="flex items-center gap-1">
          <Clock size={12} />
          {formatRelativeDay(mastery.lastAttempt)}
        </span>
      </div>
    </div>
  );
});
TopicMasteryCard.displayName = 'TopicMasteryCard';

interface TopicMasterySectionProps {
  profile: LearnerProfile | null;
  profileLoading: boolean;
  profileConfidence: 'low' | 'medium' | 'high';
  subjects: { id: string; name: string }[];
  selectedSubject: string;
}

const TopicMasterySection = React.memo<TopicMasterySectionProps>(({
  profile,
  profileLoading,
  profileConfidence,
  subjects,
  selectedSubject
}) => {
  if (profileLoading) {
    return (
      <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
        <h3 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
          <Brain size={20} className="text-purple-600" /> שליטה בנושאים
        </h3>
        <div className="flex items-center justify-center h-32 text-gray-400">
          <div className="animate-pulse">טוען פרופיל...</div>
        </div>
      </div>
    );
  }

  if (!profile || Object.keys(profile.topicMastery).length === 0) {
    return (
      <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
        <h3 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
          <Brain size={20} className="text-purple-600" /> שליטה בנושאים
        </h3>
        <div className="text-center py-8 text-gray-500">
          <Brain size={48} className="mx-auto mb-3 text-gray-300" />
          <p>עדיין אין נתונים על שליטה בנושאים.</p>
          <p className="text-sm mt-1">הנתונים יופיעו אחרי התרגול הראשון.</p>
        </div>
      </div>
    );
  }

  // Filter topics by selected subject
  const allTopics = Object.values(profile.topicMastery);
  const filteredTopics = selectedSubject === 'all'
    ? allTopics
    : allTopics.filter(t => t.subjectId === selectedSubject);

  // Group by mastery level
  const mastered = filteredTopics.filter(t => getMasteryLevel(t.pKnown) === 'mastered');
  const learning = filteredTopics.filter(t => getMasteryLevel(t.pKnown) === 'learning');
  const weak = filteredTopics.filter(t => getMasteryLevel(t.pKnown) === 'weak');

  // Sort each group by pKnown (highest first for mastered, lowest first for weak)
  mastered.sort((a, b) => b.pKnown - a.pKnown);
  learning.sort((a, b) => b.pKnown - a.pKnown);
  weak.sort((a, b) => a.pKnown - b.pKnown);

  const getSubjectName = (subjectId: string) =>
    subjects.find(s => s.id === subjectId)?.name || subjectId;

  return (
    <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
      <div className="flex justify-between items-start mb-4">
        <h3 className="text-lg font-bold text-gray-900 flex items-center gap-2">
          <Brain size={20} className="text-purple-600" /> שליטה בנושאים
        </h3>
        {/* Confidence indicator */}
        <div className="flex items-center gap-1 text-xs text-gray-500">
          <Info size={14} />
          <span>{getConfidenceMessage(profileConfidence)}</span>
        </div>
      </div>

      {/* Summary stats */}
      <div className="grid grid-cols-3 gap-3 mb-6">
        <div className="text-center p-3 bg-green-50 rounded-lg">
          <div className="text-2xl font-bold text-green-700">{mastered.length}</div>
          <div className="text-xs text-green-600">נשלט</div>
        </div>
        <div className="text-center p-3 bg-blue-50 rounded-lg">
          <div className="text-2xl font-bold text-blue-700">{learning.length}</div>
          <div className="text-xs text-blue-600">בלמידה</div>
        </div>
        <div className="text-center p-3 bg-orange-50 rounded-lg">
          <div className="text-2xl font-bold text-orange-700">{weak.length}</div>
          <div className="text-xs text-orange-600">לחיזוק</div>
        </div>
      </div>

      {/* Topic cards */}
      {filteredTopics.length > 0 ? (
        <div className="space-y-4">
          {/* Weak topics first (priority for improvement) */}
          {weak.length > 0 && (
            <div>
              <h4 className="text-sm font-semibold text-orange-700 mb-2 flex items-center gap-1">
                <AlertTriangle size={14} /> נושאים לחיזוק
              </h4>
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                {weak.map(topic => (
                  <TopicMasteryCard
                    key={`${topic.subjectId}-${topic.topic}`}
                    mastery={topic}
                    subjectName={getSubjectName(topic.subjectId)}
                  />
                ))}
              </div>
            </div>
          )}

          {/* Learning topics */}
          {learning.length > 0 && (
            <div>
              <h4 className="text-sm font-semibold text-blue-700 mb-2 flex items-center gap-1">
                <BookOpen size={14} /> בתהליך למידה
              </h4>
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                {learning.map(topic => (
                  <TopicMasteryCard
                    key={`${topic.subjectId}-${topic.topic}`}
                    mastery={topic}
                    subjectName={getSubjectName(topic.subjectId)}
                  />
                ))}
              </div>
            </div>
          )}

          {/* Mastered topics */}
          {mastered.length > 0 && (
            <div>
              <h4 className="text-sm font-semibold text-green-700 mb-2 flex items-center gap-1">
                <CheckCircle size={14} /> נושאים נשלטים
              </h4>
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                {mastered.map(topic => (
                  <TopicMasteryCard
                    key={`${topic.subjectId}-${topic.topic}`}
                    mastery={topic}
                    subjectName={getSubjectName(topic.subjectId)}
                  />
                ))}
              </div>
            </div>
          )}
        </div>
      ) : (
        <div className="text-center py-4 text-gray-500">
          אין נושאים במקצוע זה עדיין.
        </div>
      )}
    </div>
  );
});
TopicMasterySection.displayName = 'TopicMasterySection';
```

4. Add the TopicMasterySection to the main render in AnalysisTab component. Update the return JSX to include the new section. Place it before the existing progress chart:

```typescript
return (
  <div className="space-y-6 animate-fade-in">
    {/* Subject Filters */}
    <div className="flex gap-2 mb-6 overflow-x-auto pb-2">
      {/* ... existing filter buttons ... */}
    </div>

    {/* NEW: Topic Mastery Section - Full width */}
    <TopicMasterySection
      profile={profile}
      profileLoading={profileLoading}
      profileConfidence={profileConfidence}
      subjects={subjects}
      selectedSubject={analysisFilter}
    />

    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
      {/* Progress Chart */}
      <ProgressChart ... />

      <div className="space-y-6">
        {/* Strengths */}
        <StrengthsCard ... />

        {/* Weaknesses */}
        <WeaknessesCard ... />
      </div>
    </div>
  </div>
);
```
  </action>
  <verify>Run `npx tsc --noEmit` - no TypeScript errors in AnalysisTab</verify>
  <done>AnalysisTab displays TopicMasterySection with mastery cards grouped by level</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Topic Mastery display in the parent dashboard AnalysisTab showing:
- Summary stats (counts of mastered/learning/weak topics)
- Topic cards with mastery percentage, practice count, last practice date
- Visual indicators (colors, icons) for mastery levels
- Trend indicators (improving/stable/declining)
- Profile confidence message
  </what-built>
  <how-to-verify>
1. Start the dev server: `npm run dev`
2. Login as parent
3. Go to a child's detail page (click on a child from parent dashboard)
4. Navigate to the Analysis/Analytics tab
5. Verify you see:
   - "שליטה בנושאים" section with Brain icon
   - If no profile data: empty state message "עדיין אין נתונים על שליטה בנושאים"
   - If profile exists: summary stats (green/blue/orange boxes with counts)
   - Topic cards showing: topic name, subject, mastery %, practice count, last practice date
   - Colors: green for mastered (>=80%), blue for learning (50-79%), orange for weak (<50%)
   - Subject filter affects which topics are shown
6. Complete a quiz with the child to generate profile data if needed
7. Refresh the AnalysisTab and verify the new quiz data appears
  </how-to-verify>
  <resume-signal>Type "approved" if the UI displays correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit` passes with no errors
2. AnalysisTab accepts profile, profileLoading, profileConfidence props
3. TopicMasterySection renders with mastery cards
4. Cards show mastery percentage, attempts count, last practice date
5. Topics grouped by mastery level (weak first, then learning, then mastered)
6. Subject filter affects topic display
</verification>

<success_criteria>
- Parent can view child's topic mastery list in AnalysisTab
- Topics categorized as mastered (green), learning (blue), weak (orange)
- Each topic shows: mastery probability (%), practice count, last practice date
- Profile confidence indicator shows data completeness message
- Empty state shown when no profile data exists
- Subject filter filters displayed topics
</success_criteria>

<output>
After completion, create `.planning/phases/01-profile-foundation/01-04-SUMMARY.md`
</output>
