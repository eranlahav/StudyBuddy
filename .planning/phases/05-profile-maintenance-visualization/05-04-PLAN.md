---
phase: 05-profile-maintenance-visualization
plan: 04
type: execute
wave: 2
depends_on: []
files_modified:
  - services/prerequisiteService.ts
  - services/index.ts
autonomous: true

must_haves:
  truths:
    - "AI detects topic dependencies (e.g., addition before multiplication)"
    - "Prerequisites shown with Hebrew rationale"
    - "Graceful degradation if AI fails (returns empty array)"
    - "Confidence score filters low-quality suggestions"
  artifacts:
    - path: "services/prerequisiteService.ts"
      provides: "Gemini-powered prerequisite detection"
      exports: ["detectPrerequisites", "getPrerequisiteMessage", "PrerequisiteRelationship"]
  key_links:
    - from: "services/prerequisiteService.ts"
      to: "services/geminiService.ts"
      via: "generateContent import"
      pattern: "import.*generateContent.*from.*geminiService"
---

<objective>
Create the prerequisite detection service using Gemini AI.

Purpose: Identify topic dependencies so parents see "Fix X first, then Y will make sense" recommendations. This helps prioritize remediation efforts effectively.

Output: `services/prerequisiteService.ts` with AI-powered prerequisite detection and Hebrew message formatting.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-profile-maintenance-visualization/05-RESEARCH.md

# Existing Gemini service
@services/geminiService.ts
@types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create prerequisite detection service</name>
  <files>services/prerequisiteService.ts, services/index.ts</files>
  <action>
Create `services/prerequisiteService.ts` with:

1. **PrerequisiteRelationship interface** (not exported to types.ts - service-internal):
```typescript
export interface PrerequisiteRelationship {
  topic: string;           // The weak topic
  prerequisite: string;    // Topic that should be learned first
  confidence: number;      // 0-1 AI confidence
  rationale: string;       // Hebrew explanation
}
```

2. **PREREQUISITE_CONFIG** constant:
```typescript
const PREREQUISITE_CONFIG = {
  /** Minimum AI confidence to show suggestion */
  MIN_CONFIDENCE: 0.7,
  /** Maximum relationships to return */
  MAX_RESULTS: 5
};
```

3. **detectPrerequisites(weakTopics, allTopics, subjectName, gradeLevel): Promise<PrerequisiteRelationship[]>**
   - Return empty array if weakTopics is empty
   - Create Gemini prompt (Hebrew):
```
אתה מומחה חינוכי ישראלי. נתון:
- מקצוע: ${subjectName}
- כיתה: ${gradeLevel}
- נושאים חלשים: ${weakTopics.map(t => t.topic).join(', ')}
- כל הנושאים: ${allTopics.map(t => t.topic).join(', ')}

זהה **קשרי תלות (prerequisites)** בין נושאים.
לכל נושא חלש, מצא האם יש נושא אחר שחייבים לחזק לפניו.

דוגמה:
- נושא חלש: "כפל שברים"
- תלות: "שברים בסיסיים"
- הסבר: "כדי להצליח בכפל שברים, תחילה צריך להבין שברים בסיסיים"

החזר JSON array:
[
  {
    "topic": "הנושא החלש",
    "prerequisite": "הנושא שצריך לחזק לפני",
    "confidence": 0.9,
    "rationale": "הסבר בעברית"
  }
]

אם אין תלויות ברורות, החזר [].
```
   - Call generateContent from geminiService
   - Parse JSON from response (handle markdown code blocks)
   - Filter by MIN_CONFIDENCE (0.7)
   - Return up to MAX_RESULTS relationships
   - On error: log warning, return empty array (graceful degradation)

4. **getPrerequisiteMessage(relationship): string**
   - Return Hebrew message: `מומלץ לחזק את "${relationship.prerequisite}" לפני "${relationship.topic}". ${relationship.rationale}`

5. **Export from services/index.ts**

Import `generateContent` from `./geminiService`.
Import `TopicMastery` from `../types`.
Use `logger` from `../lib` for error logging.
Use `retry` from `../lib` for API resilience.
  </action>
  <verify>
Run `npx tsc --noEmit` - no type errors

Manual verification:
- Empty weakTopics returns empty array immediately
- JSON parsing handles Gemini's markdown code block format
- Low confidence results filtered out
- API errors logged but don't throw (graceful degradation)
  </verify>
  <done>
AI detects prerequisite relationships (success criteria #7).
Hebrew rationale provided for each relationship.
Graceful degradation on API failure.
Confidence filtering removes low-quality suggestions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add grade level extraction helper</name>
  <files>services/prerequisiteService.ts</files>
  <action>
Add helper function to extract numeric grade from GradeLevel enum:

```typescript
/**
 * Extract numeric grade from GradeLevel enum for prompt
 * Examples: "כיתה א'" -> 1, "כיתה ג'" -> 3
 */
function gradeToNumber(grade: GradeLevel): number {
  const match = grade.match(/[א-ח]/);
  if (!match) return 3; // Default to grade 3

  const hebrewNumerals: Record<string, number> = {
    'א': 1, 'ב': 2, 'ג': 3, 'ד': 4,
    'ה': 5, 'ו': 6, 'ז': 7, 'ח': 8
  };

  return hebrewNumerals[match[0]] || 3;
}
```

Update `detectPrerequisites` to use `gradeToNumber(gradeLevel)` in the prompt.

This ensures the prompt contains a number (1-8) rather than Hebrew text for clearer AI understanding.
  </action>
  <verify>
Run `npx tsc --noEmit` - no type errors

Manual verification:
- gradeToNumber(GradeLevel.Grade1) returns 1
- gradeToNumber(GradeLevel.Grade8) returns 8
  </verify>
  <done>
Grade level correctly extracted for AI prompt.
Prompt uses numeric grade (1-8) for clearer AI understanding.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. Prerequisite detection:
   - Calls Gemini with Hebrew prompt
   - Parses JSON response correctly
   - Filters by confidence threshold
   - Returns empty array on error
3. Hebrew message formatting works correctly
4. Grade extraction handles all GradeLevel enum values
</verification>

<success_criteria>
- AI detects prerequisite relationships (success criteria #7)
- Hebrew rationale: "Fix X first, then Y will make sense"
- Confidence filtering prevents low-quality suggestions
- Graceful degradation on API failure
</success_criteria>

<output>
After completion, create `.planning/phases/05-profile-maintenance-visualization/05-04-SUMMARY.md`
</output>
