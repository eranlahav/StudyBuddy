---
phase: 05-profile-maintenance-visualization
plan: 06
type: execute
wave: 3
depends_on: ["05-01", "05-02", "05-03", "05-05"]
files_modified:
  - services/profileService.ts
  - hooks/useLearnerProfile.ts
  - pages/ChildDetails/AnalysisTab.tsx
autonomous: true

must_haves:
  truths:
    - "Profile reads apply forgetting curve decay automatically"
    - "Regression detection triggers alerts on profile updates"
    - "AnalysisTab displays radar chart and timeline"
    - "Review mode banner shows after 3+ week gap"
  artifacts:
    - path: "services/profileService.ts"
      provides: "getProfileWithDecay wrapper function"
      exports: ["getProfileWithDecay"]
    - path: "hooks/useLearnerProfile.ts"
      provides: "Regression detection on profile changes"
      contains: "detectRegression"
    - path: "pages/ChildDetails/AnalysisTab.tsx"
      provides: "Integrated visualization components"
      contains: "SkillRadarChart"
  key_links:
    - from: "services/profileService.ts"
      to: "lib/forgettingCurve.ts"
      via: "applyForgettingCurveToProfile import"
      pattern: "import.*applyForgettingCurveToProfile.*from.*forgettingCurve"
    - from: "hooks/useLearnerProfile.ts"
      to: "services/alertService.ts"
      via: "detectRegression import"
      pattern: "import.*detectRegression.*from.*alertService"
    - from: "pages/ChildDetails/AnalysisTab.tsx"
      to: "pages/ChildDetails/SkillRadarChart.tsx"
      via: "Component import"
      pattern: "import.*SkillRadarChart.*from"
---

<objective>
Integrate all Phase 5 features into the existing profile service, hook, and UI.

Purpose: Wire forgetting curve decay into profile reads, regression detection into profile updates, and visualization components into AnalysisTab. This completes the maintenance and visualization pipeline.

Output: Extended profileService with decay wrapper, useLearnerProfile with alert detection, AnalysisTab with radar/timeline charts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-profile-maintenance-visualization/05-RESEARCH.md

# Dependencies from earlier plans
@lib/forgettingCurve.ts  # Plan 01
@services/alertService.ts  # Plan 02
@services/probeScheduler.ts  # Plan 03
@pages/ChildDetails/SkillRadarChart.tsx  # Plan 05
@pages/ChildDetails/ProgressTimeline.tsx  # Plan 05

# Files to extend
@services/profileService.ts
@hooks/useLearnerProfile.ts
@pages/ChildDetails/AnalysisTab.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add decay wrapper to profile service</name>
  <files>services/profileService.ts</files>
  <action>
Add `getProfileWithDecay` function to `services/profileService.ts`:

1. Import at top:
```typescript
import { applyForgettingCurveToProfile } from '../lib/forgettingCurve';
```

2. Add function after existing `getProfile`:
```typescript
/**
 * Get learner profile with forgetting curve applied
 * Decay is read-only calculation, doesn't modify Firestore
 * Use this for display; use getProfile for raw data
 */
export async function getProfileWithDecay(childId: string): Promise<LearnerProfile | null> {
  const profile = await getProfile(childId);
  if (!profile) return null;

  return applyForgettingCurveToProfile(profile);
}
```

This provides a convenient wrapper that applies decay without modifying stored data.
  </action>
  <verify>Run `npx tsc --noEmit` - no type errors</verify>
  <done>Profile service has getProfileWithDecay wrapper that applies forgetting curve</done>
</task>

<task type="auto">
  <name>Task 2: Add regression detection to useLearnerProfile hook</name>
  <files>hooks/useLearnerProfile.ts</files>
  <action>
Extend `hooks/useLearnerProfile.ts` with regression detection:

1. Add imports at top:
```typescript
import { detectRegression, createRegressionAlert, shouldAlertForRegression } from '../services/alertService';
import { applyForgettingCurveToProfile } from '../lib/forgettingCurve';
import { RegressionAlert, ChildProfile as ChildProfileType } from '../types';
```

2. Add `alerts` state to hook return:
```typescript
// Add to state declarations:
const [alerts, setAlerts] = useState<RegressionAlert[]>([]);

// Track previous profile for regression comparison
const prevProfileRef = useRef<LearnerProfile | null>(null);
```

3. Add regression detection in the subscription callback (after setProfile):
```typescript
// Inside the onData callback, after setProfile(data):

// Apply forgetting curve for display
const decayedProfile = data ? applyForgettingCurveToProfile(data) : null;

// Check for regressions (compare raw profiles, not decayed)
if (data && prevProfileRef.current && child) {
  const newAlerts: RegressionAlert[] = [];

  for (const [key, currentMastery] of Object.entries(data.topicMastery)) {
    const prevMastery = prevProfileRef.current.topicMastery[key];

    if (detectRegression(currentMastery, prevMastery)) {
      // Check cooldown
      if (shouldAlertForRegression(currentMastery, currentMastery.lastAlertedAt)) {
        // Find subject name (need subjects from somewhere - pass via context or props)
        const subjectName = currentMastery.subjectId; // Simplified - full impl would lookup

        const alert = createRegressionAlert(
          child as unknown as { id: string; name: string },
          currentMastery,
          subjectName,
          prevMastery!.pKnown
        );

        newAlerts.push(alert);
        logger.info('useLearnerProfile: Regression detected', {
          topic: currentMastery.topic,
          prevPKnown: prevMastery!.pKnown,
          currentPKnown: currentMastery.pKnown
        });
      }
    }
  }

  if (newAlerts.length > 0) {
    setAlerts(prev => [...prev, ...newAlerts]);
  }
}

prevProfileRef.current = data;
```

4. Update return type and return value:
```typescript
// Add to UseLearnerProfileReturn interface:
/** Regression alerts detected */
alerts: RegressionAlert[];
/** Dismiss an alert */
dismissAlert: (alertId: string) => void;
/** Profile with forgetting curve applied (for display) */
decayedProfile: LearnerProfile | null;

// Add dismissAlert function:
const dismissAlert = useCallback((alertId: string) => {
  setAlerts(prev => prev.filter(a => a.id !== alertId));
}, []);

// Add decayedProfile state:
const [decayedProfile, setDecayedProfile] = useState<LearnerProfile | null>(null);

// In subscription callback, after decay calculation:
setDecayedProfile(decayedProfile);

// Update return:
return {
  profile,
  decayedProfile,  // NEW: profile with decay applied
  isLoading,
  error,
  refresh,
  getTopicsByMastery,
  getConfidenceLevel,
  alerts,          // NEW
  dismissAlert     // NEW
};
```

Note: The alert detection compares RAW profiles, not decayed ones, because decay alone shouldn't trigger alerts - only actual regression from practice should.
  </action>
  <verify>Run `npx tsc --noEmit` - no type errors</verify>
  <done>
useLearnerProfile detects regressions and maintains alert state.
decayedProfile provides forgetting-curve-adjusted data for display.
dismissAlert allows clearing alerts.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate visualizations into AnalysisTab</name>
  <files>pages/ChildDetails/AnalysisTab.tsx</files>
  <action>
Extend `pages/ChildDetails/AnalysisTab.tsx` with radar chart and timeline:

1. Add imports at top:
```typescript
import { SkillRadarChart } from './SkillRadarChart';
import { ProgressTimeline } from './ProgressTimeline';
```

2. Add state for selected topic (for timeline drill-down):
```typescript
const [selectedTopic, setSelectedTopic] = useState<string | null>(null);
```

3. Add radar chart section after TopicMasterySection (inside the main return, before the grid):
```typescript
{/* Skill Radar Chart - only show if subject selected and profile exists */}
{analysisFilter !== 'all' && profile && (
  <SkillRadarChart
    profile={profile}
    subjectId={analysisFilter}
    subjectName={subjects.find(s => s.id === analysisFilter)?.name || analysisFilter}
  />
)}
```

4. Add timeline section (conditionally when topic selected):
```typescript
{/* Progress Timeline - shown when topic clicked */}
{selectedTopic && (
  <div className="mb-6">
    <div className="flex justify-between items-center mb-2">
      <h3 className="text-lg font-bold text-gray-900">מגמת התקדמות</h3>
      <button
        onClick={() => setSelectedTopic(null)}
        className="text-sm text-indigo-600 hover:text-indigo-800"
      >
        סגור
      </button>
    </div>
    <ProgressTimeline
      topic={selectedTopic}
      sessions={sessions}
      currentMastery={profile?.topicMastery[selectedTopic]}
    />
  </div>
)}
```

5. Make TopicMasteryCard clickable to show timeline:
In the TopicMasteryCard component, wrap the card in a button/div with onClick:
```typescript
// Add onTopicSelect prop to TopicMasteryCard
interface TopicMasteryCardProps {
  mastery: TopicMastery;
  subjectName: string;
  onSelect?: () => void;  // NEW
}

// In the card's outer div:
<div
  className={`p-4 rounded-xl border ${config.bg} ${config.border} ${onSelect ? 'cursor-pointer hover:shadow-md transition-shadow' : ''}`}
  onClick={onSelect}
  role={onSelect ? 'button' : undefined}
  tabIndex={onSelect ? 0 : undefined}
>
```

6. Pass onSelect to TopicMasteryCard in TopicMasterySection:
```typescript
<TopicMasteryCard
  key={...}
  mastery={topic}
  subjectName={getSubjectName(topic.subjectId)}
  onSelect={() => setSelectedTopic(`${topic.subjectId}-${topic.topic}`)}
/>
```

Note: The selectedTopic uses composite key to handle same topic name across subjects.
Update ProgressTimeline to look up mastery by composite key, or pass the full mastery object.
  </action>
  <verify>Run `npx tsc --noEmit` - no type errors</verify>
  <done>
AnalysisTab displays radar chart when subject filtered (success criteria #5).
Clicking topic shows progress timeline (success criteria #6).
Components integrated with existing tab structure.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. Profile service:
   - getProfileWithDecay returns profile with decay applied
   - Original getProfile unchanged
3. useLearnerProfile hook:
   - Returns decayedProfile with forgetting curve applied
   - Detects regressions and populates alerts array
   - dismissAlert removes alert from state
4. AnalysisTab:
   - Radar chart shows when subject selected
   - Timeline shows when topic clicked
   - Cards are clickable for drill-down
</verification>

<success_criteria>
- Profile reads apply forgetting curve automatically (success criteria #1)
- Regression detection triggers alerts (success criteria #4)
- Radar chart in AnalysisTab (success criteria #5)
- Timeline in AnalysisTab (success criteria #6)
- All components integrated without breaking existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/05-profile-maintenance-visualization/05-06-SUMMARY.md`
</output>
