---
phase: 05-profile-maintenance-visualization
plan: 06
type: execute
wave: 3
depends_on: ["05-01", "05-02"]
files_modified:
  - services/profileService.ts
  - hooks/useLearnerProfile.ts
autonomous: true

must_haves:
  truths:
    - "Profile reads apply forgetting curve decay automatically"
    - "Regression detection triggers alerts on profile updates"
    - "Alerts displayed via in-app notification banner"
  artifacts:
    - path: "services/profileService.ts"
      provides: "getProfileWithDecay wrapper function"
      exports: ["getProfileWithDecay"]
    - path: "hooks/useLearnerProfile.ts"
      provides: "Regression detection and alert state with notifications"
      contains: "detectRegression"
  key_links:
    - from: "services/profileService.ts"
      to: "lib/forgettingCurve.ts"
      via: "applyForgettingCurveToProfile import"
      pattern: "import.*applyForgettingCurveToProfile.*from.*forgettingCurve"
    - from: "hooks/useLearnerProfile.ts"
      to: "services/alertService.ts"
      via: "detectRegression import"
      pattern: "import.*detectRegression.*from.*alertService"
---

<objective>
Add forgetting curve decay to profile reads and regression detection with notifications to the profile hook.

Purpose: Wire forgetting curve decay into profile reads and regression detection into profile updates. Alerts are displayed via in-app notification banner (not just React state).

Output: Extended profileService with decay wrapper, useLearnerProfile with alert detection and dismissable notification UI.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-profile-maintenance-visualization/05-RESEARCH.md

# Dependencies from earlier plans
@lib/forgettingCurve.ts  # Plan 01
@services/alertService.ts  # Plan 02

# Files to extend
@services/profileService.ts
@hooks/useLearnerProfile.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add decay wrapper to profile service</name>
  <files>services/profileService.ts</files>
  <action>
Add `getProfileWithDecay` function to `services/profileService.ts`:

1. Import at top:
```typescript
import { applyForgettingCurveToProfile } from '../lib/forgettingCurve';
```

2. Add function after existing `getProfile`:
```typescript
/**
 * Get learner profile with forgetting curve applied
 * Decay is read-only calculation, doesn't modify Firestore
 * Use this for display; use getProfile for raw data
 */
export async function getProfileWithDecay(childId: string): Promise<LearnerProfile | null> {
  const profile = await getProfile(childId);
  if (!profile) return null;

  return applyForgettingCurveToProfile(profile);
}
```

This provides a convenient wrapper that applies decay without modifying stored data.
  </action>
  <verify>Run `npx tsc --noEmit` - no type errors</verify>
  <done>Profile service has getProfileWithDecay wrapper that applies forgetting curve</done>
</task>

<task type="auto">
  <name>Task 2: Add regression detection with notification to useLearnerProfile hook</name>
  <files>hooks/useLearnerProfile.ts</files>
  <action>
Extend `hooks/useLearnerProfile.ts` with regression detection and notification display:

1. Add imports at top:
```typescript
import { detectRegression, createRegressionAlert, shouldAlertForRegression } from '../services/alertService';
import { applyForgettingCurveToProfile } from '../lib/forgettingCurve';
import { RegressionAlert, ChildProfile as ChildProfileType } from '../types';
```

2. Add alert state and notification state:
```typescript
// Add to state declarations:
const [alerts, setAlerts] = useState<RegressionAlert[]>([]);
const [activeNotification, setActiveNotification] = useState<RegressionAlert | null>(null);

// Track previous profile for regression comparison
const prevProfileRef = useRef<LearnerProfile | null>(null);
```

3. Add regression detection in the subscription callback (after setProfile):
```typescript
// Inside the onData callback, after setProfile(data):

// Apply forgetting curve for display
const decayedProfile = data ? applyForgettingCurveToProfile(data) : null;

// Check for regressions (compare raw profiles, not decayed)
if (data && prevProfileRef.current && child) {
  const newAlerts: RegressionAlert[] = [];

  for (const [key, currentMastery] of Object.entries(data.topicMastery)) {
    const prevMastery = prevProfileRef.current.topicMastery[key];

    if (detectRegression(currentMastery, prevMastery)) {
      // Check cooldown
      if (shouldAlertForRegression(currentMastery, currentMastery.lastAlertedAt)) {
        // Find subject name (need subjects from somewhere - pass via context or props)
        const subjectName = currentMastery.subjectId; // Simplified - full impl would lookup

        const alert = createRegressionAlert(
          child as unknown as { id: string; name: string },
          currentMastery,
          subjectName,
          prevMastery!.pKnown
        );

        newAlerts.push(alert);
        logger.info('useLearnerProfile: Regression detected', {
          topic: currentMastery.topic,
          prevPKnown: prevMastery!.pKnown,
          currentPKnown: currentMastery.pKnown
        });
      }
    }
  }

  if (newAlerts.length > 0) {
    setAlerts(prev => [...prev, ...newAlerts]);
    // Show most recent alert as notification
    setActiveNotification(newAlerts[0]);
  }
}

prevProfileRef.current = data;
```

4. Add notification auto-dismiss (after 8 seconds):
```typescript
// Add useEffect for auto-dismiss:
useEffect(() => {
  if (activeNotification) {
    const timer = setTimeout(() => {
      setActiveNotification(null);
    }, 8000); // 8 seconds
    return () => clearTimeout(timer);
  }
}, [activeNotification]);
```

5. Update return type and return value:
```typescript
// Add to UseLearnerProfileReturn interface:
/** Regression alerts detected */
alerts: RegressionAlert[];
/** Currently displayed notification (auto-dismisses after 8s) */
activeNotification: RegressionAlert | null;
/** Dismiss an alert */
dismissAlert: (alertId: string) => void;
/** Dismiss the active notification */
dismissNotification: () => void;
/** Profile with forgetting curve applied (for display) */
decayedProfile: LearnerProfile | null;

// Add dismissAlert function:
const dismissAlert = useCallback((alertId: string) => {
  setAlerts(prev => prev.filter(a => a.id !== alertId));
}, []);

// Add dismissNotification function:
const dismissNotification = useCallback(() => {
  setActiveNotification(null);
}, []);

// Add decayedProfile state:
const [decayedProfile, setDecayedProfile] = useState<LearnerProfile | null>(null);

// In subscription callback, after decay calculation:
setDecayedProfile(decayedProfile);

// Update return:
return {
  profile,
  decayedProfile,  // NEW: profile with decay applied
  isLoading,
  error,
  refresh,
  getTopicsByMastery,
  getConfidenceLevel,
  alerts,              // NEW
  activeNotification,  // NEW: for notification banner
  dismissAlert,        // NEW
  dismissNotification  // NEW
};
```

Note: The alert detection compares RAW profiles, not decayed ones, because decay alone shouldn't trigger alerts - only actual regression from practice should.

The activeNotification is the key addition - it provides a transient notification that auto-dismisses, giving parents real-time feedback when regressions occur.
  </action>
  <verify>Run `npx tsc --noEmit` - no type errors</verify>
  <done>
useLearnerProfile detects regressions and maintains alert state.
activeNotification provides real-time notification (auto-dismisses after 8s).
decayedProfile provides forgetting-curve-adjusted data for display.
dismissAlert and dismissNotification allow clearing alerts.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. Profile service:
   - getProfileWithDecay returns profile with decay applied
   - Original getProfile unchanged
3. useLearnerProfile hook:
   - Returns decayedProfile with forgetting curve applied
   - Detects regressions and populates alerts array
   - Sets activeNotification when regression detected
   - Notification auto-dismisses after 8 seconds
   - dismissAlert removes alert from state
   - dismissNotification clears active notification
</verification>

<success_criteria>
- Profile reads apply forgetting curve automatically (success criteria #1)
- Regression detection triggers alerts (success criteria #4)
- Alerts displayed via activeNotification state (for UI banner)
- Notification auto-dismisses after 8 seconds
</success_criteria>

<output>
After completion, create `.planning/phases/05-profile-maintenance-visualization/05-06-SUMMARY.md`
</output>
