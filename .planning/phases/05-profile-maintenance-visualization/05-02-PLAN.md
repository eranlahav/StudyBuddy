---
phase: 05-profile-maintenance-visualization
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - types.ts
  - services/alertService.ts
  - services/index.ts
autonomous: true

must_haves:
  truths:
    - "Parent receives alert when mastered topic (>=0.8) drops below 70%"
    - "Alert includes Hebrew message with child name and topic"
    - "Same topic doesn't alert again for 14 days (cooldown)"
    - "Alerts can be dismissed by parent"
  artifacts:
    - path: "services/alertService.ts"
      provides: "Regression detection and alert creation"
      exports: ["detectRegression", "createRegressionAlert", "ALERT_CONFIG", "RegressionAlert"]
    - path: "types.ts"
      provides: "RegressionAlert interface"
      contains: "interface RegressionAlert"
  key_links:
    - from: "services/alertService.ts"
      to: "types.ts"
      via: "RegressionAlert import"
      pattern: "import.*RegressionAlert.*from.*types"
---

<objective>
Create the alert service for detecting and reporting topic regressions.

Purpose: Notify parents when a child's previously-mastered topic drops below critical threshold (70%). This enables early intervention before knowledge gaps widen.

Output: `services/alertService.ts` with detection logic and alert creation, `RegressionAlert` type in types.ts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-profile-maintenance-visualization/05-RESEARCH.md

# Existing files
@types.ts
@services/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add RegressionAlert type</name>
  <files>types.ts</files>
  <action>
Add the RegressionAlert interface at the end of the file (before any exports, after the Phase 4 types section):

```typescript
// ==========================================
// REGRESSION ALERT TYPES (Phase 5)
// ==========================================

/**
 * Alert for parent when child's mastery regresses
 * Generated when pKnown drops from mastered (>=0.8) to below 0.7
 */
export interface RegressionAlert {
  id: string;
  childId: string;
  childName: string;
  topic: string;
  subjectId: string;
  subjectName: string;
  previousPKnown: number;
  currentPKnown: number;
  message: string;              // Hebrew message for parent
  timestamp: number;
  dismissed: boolean;
  lastAlertedAt?: number;       // For cooldown tracking
}
```
  </action>
  <verify>Run `npx tsc --noEmit` - no type errors</verify>
  <done>RegressionAlert interface exists in types.ts</done>
</task>

<task type="auto">
  <name>Task 2: Create alert service</name>
  <files>services/alertService.ts, services/index.ts</files>
  <action>
Create `services/alertService.ts` with:

1. **ALERT_CONFIG** constant:
```typescript
export const ALERT_CONFIG = {
  /** Trigger alert when pKnown drops below this */
  REGRESSION_THRESHOLD: 0.70,
  /** Only alert if topic was previously above this */
  PREVIOUS_MASTERY_THRESHOLD: 0.80,
  /** Cooldown between alerts for same topic (days) */
  ALERT_COOLDOWN_DAYS: 14,
  /** Minimum drop in pKnown to trigger (prevents noise) */
  MIN_DROP_THRESHOLD: 0.10
};
```

2. **detectRegression(currentMastery, previousMastery): boolean**
   - Return false if previousMastery is undefined
   - Check: was mastered (>=0.8) AND now below 0.7
   - Check: drop is at least 10 percentage points
   - Returns true if regression detected

3. **shouldAlertForRegression(mastery, lastAlertedAt): boolean**
   - Returns false if lastAlertedAt was within ALERT_COOLDOWN_DAYS
   - Uses daysSince from lib/signalWeights.ts

4. **createRegressionAlert(child, mastery, subjectName, previousPKnown): RegressionAlert**
   - Generate unique ID: `alert_${child.id}_${mastery.topic}_${Date.now()}`
   - Create Hebrew message: `${child.name} נראה/ת מתקשה ב${mastery.topic} (${subjectName})`
   - Return complete RegressionAlert object

5. **formatAlertMessage(childName, topic, subjectName): string**
   - Helper for consistent Hebrew message formatting
   - Pattern: "[name] נראה/ת מתקשה ב[topic] ([subject])"

6. **Export from services/index.ts**

Import `daysSince` from `../lib/signalWeights`.
Import types from `../types`.
Use logger from `../lib` for debug logging.
  </action>
  <verify>
Run `npx tsc --noEmit` - no type errors

Manual verification of logic:
- Mastery drop from 0.85 to 0.65: detectRegression returns true
- Mastery drop from 0.75 to 0.65: detectRegression returns false (wasn't mastered)
- Mastery drop from 0.85 to 0.75: detectRegression returns false (still above threshold)
  </verify>
  <done>
Alert service detects regressions when mastered topics drop below 70%.
14-day cooldown prevents alert fatigue.
Hebrew messages include child name and topic.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. RegressionAlert type exists with all required fields
3. detectRegression correctly identifies:
   - 0.85 -> 0.65: TRUE (mastered, now below threshold, 20pt drop)
   - 0.75 -> 0.65: FALSE (wasn't mastered)
   - 0.85 -> 0.75: FALSE (still above threshold)
   - 0.85 -> 0.72: TRUE (mastered, now below threshold, 13pt drop)
4. Cooldown logic prevents repeated alerts within 14 days
5. Hebrew message format matches success criteria #4
</verification>

<success_criteria>
- Regression detected when pKnown drops from >=0.8 to <0.7 (meets success criteria #4)
- Hebrew message format: "[name] נראה/ת מתקשה ב[topic]"
- 14-day cooldown prevents alert fatigue
- Minimum 10% drop threshold reduces noise from minor fluctuations
</success_criteria>

<output>
After completion, create `.planning/phases/05-profile-maintenance-visualization/05-02-SUMMARY.md`
</output>
