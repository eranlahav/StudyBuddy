---
phase: 05-profile-maintenance-visualization
plan: 07
type: execute
wave: 3
depends_on: ["05-05", "05-06"]
files_modified:
  - pages/ChildDetails/AnalysisTab.tsx
autonomous: true

must_haves:
  truths:
    - "AnalysisTab displays radar chart when subject selected"
    - "Clicking topic card shows progress timeline"
    - "Timeline receives full TopicMastery object (not composite key)"
    - "Review mode banner shows after 3+ week gap"
  artifacts:
    - path: "pages/ChildDetails/AnalysisTab.tsx"
      provides: "Integrated visualization components with drill-down"
      contains: "SkillRadarChart"
  key_links:
    - from: "pages/ChildDetails/AnalysisTab.tsx"
      to: "pages/ChildDetails/SkillRadarChart.tsx"
      via: "Component import"
      pattern: "import.*SkillRadarChart.*from"
    - from: "pages/ChildDetails/AnalysisTab.tsx"
      to: "pages/ChildDetails/ProgressTimeline.tsx"
      via: "Component import"
      pattern: "import.*ProgressTimeline.*from"
---

<objective>
Integrate visualization components (radar chart, timeline) into AnalysisTab with proper data passing.

Purpose: Wire the visualization components created in Plan 05-05 into the AnalysisTab. Fix the selectedTopic state to pass the full TopicMastery object (not composite key string) to ProgressTimeline.

Output: AnalysisTab with integrated radar/timeline charts, proper drill-down from topic cards to timeline.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-profile-maintenance-visualization/05-RESEARCH.md

# Dependencies from earlier plans
@pages/ChildDetails/SkillRadarChart.tsx  # Plan 05
@pages/ChildDetails/ProgressTimeline.tsx  # Plan 05

# File to extend
@pages/ChildDetails/AnalysisTab.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate radar chart into AnalysisTab</name>
  <files>pages/ChildDetails/AnalysisTab.tsx</files>
  <action>
Add SkillRadarChart to AnalysisTab:

1. Add import at top:
```typescript
import { SkillRadarChart } from './SkillRadarChart';
```

2. Add radar chart section after TopicMasterySection, before the grid:
```typescript
{/* Skill Radar Chart - only show if subject selected and profile exists */}
{analysisFilter !== 'all' && profile && (
  <SkillRadarChart
    profile={profile}
    subjectId={analysisFilter}
    subjectName={subjects.find(s => s.id === analysisFilter)?.name || analysisFilter}
  />
)}
```

This shows the radar chart when a specific subject is selected (not "all").
  </action>
  <verify>Run `npx tsc --noEmit` - no type errors</verify>
  <done>Radar chart displays when subject is filtered in AnalysisTab</done>
</task>

<task type="auto">
  <name>Task 2: Add timeline with proper TopicMastery passing</name>
  <files>pages/ChildDetails/AnalysisTab.tsx</files>
  <action>
Add ProgressTimeline with drill-down from topic cards:

1. Add import at top:
```typescript
import { ProgressTimeline } from './ProgressTimeline';
import { TopicMastery } from '../../types';
```

2. Add state for selected topic (using full TopicMastery object, NOT composite key string):
```typescript
// IMPORTANT: Store the full TopicMastery object, not just a string key
// This avoids lookup issues with composite keys not matching topicMastery structure
const [selectedTopic, setSelectedTopic] = useState<TopicMastery | null>(null);
```

3. Add timeline section (conditionally when topic selected):
```typescript
{/* Progress Timeline - shown when topic clicked */}
{selectedTopic && (
  <div className="mb-6">
    <div className="flex justify-between items-center mb-2">
      <h3 className="text-lg font-bold text-gray-900">מגמת התקדמות</h3>
      <button
        onClick={() => setSelectedTopic(null)}
        className="text-sm text-indigo-600 hover:text-indigo-800"
      >
        סגור
      </button>
    </div>
    <ProgressTimeline
      topic={selectedTopic.topic}
      sessions={sessions}
      currentMastery={selectedTopic}
    />
  </div>
)}
```

4. Update TopicMasteryCard to accept onSelect callback:
```typescript
interface TopicMasteryCardProps {
  mastery: TopicMastery;
  subjectName: string;
  onSelect?: () => void;  // NEW: callback for drill-down
}

// In the card's outer div, add click handler:
<div
  className={`p-4 rounded-xl border ${config.bg} ${config.border} ${onSelect ? 'cursor-pointer hover:shadow-md transition-shadow' : ''}`}
  onClick={onSelect}
  role={onSelect ? 'button' : undefined}
  tabIndex={onSelect ? 0 : undefined}
  onKeyDown={onSelect ? (e) => e.key === 'Enter' && onSelect() : undefined}
>
```

5. Pass the full TopicMastery object to setSelectedTopic (NOT a composite key):
```typescript
// In TopicMasterySection, update TopicMasteryCard usage:
<TopicMasteryCard
  key={`${topic.subjectId}-${topic.topic}`}
  mastery={topic}
  subjectName={getSubjectName(topic.subjectId)}
  onSelect={() => setSelectedTopic(topic)}  // Pass full TopicMastery object
/>
```

IMPORTANT: The key fix here is passing the full `topic` (TopicMastery) object to setSelectedTopic,
rather than a composite string like `${topic.subjectId}-${topic.topic}`.

This ensures:
- ProgressTimeline receives the actual TopicMastery object via `currentMastery` prop
- No lookup needed (which would fail because profile.topicMastery uses topic name as key, not composite key)
- Timeline has direct access to pKnown, dimensions, etc.

6. Add selectedTopic and setSelectedTopic to TopicMasterySection props:
```typescript
interface TopicMasterySectionProps {
  // ... existing props
  selectedTopic: TopicMastery | null;
  setSelectedTopic: (topic: TopicMastery | null) => void;
}
```

And pass them from AnalysisTab:
```typescript
<TopicMasterySection
  profile={profile}
  profileLoading={profileLoading}
  profileConfidence={profileConfidence}
  subjects={subjects}
  selectedSubject={analysisFilter}
  selectedTopic={selectedTopic}
  setSelectedTopic={setSelectedTopic}
/>
```
  </action>
  <verify>Run `npx tsc --noEmit` - no type errors</verify>
  <done>
Timeline integrated with proper data passing.
selectedTopic stores full TopicMastery object (not composite key).
Topic cards clickable for drill-down.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. AnalysisTab:
   - Radar chart shows when subject selected
   - Timeline shows when topic clicked
   - Cards are clickable for drill-down
   - selectedTopic is TopicMastery object (not string)
   - ProgressTimeline receives currentMastery prop correctly
</verification>

<success_criteria>
- Radar chart in AnalysisTab (success criteria #5)
- Timeline in AnalysisTab (success criteria #6)
- Clicking topic card shows timeline with correct mastery data
- No composite key lookup issues
- All components integrated without breaking existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/05-profile-maintenance-visualization/05-07-SUMMARY.md`
</output>
