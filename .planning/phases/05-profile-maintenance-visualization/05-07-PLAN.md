---
phase: 05-profile-maintenance-visualization
plan: 07
type: execute
wave: 3
depends_on: ["05-05", "05-06"]
files_modified:
  - pages/ChildDetails/AnalysisTab.tsx
  - pages/ChildDetails/ReviewModeBanner.tsx
autonomous: true

must_haves:
  truths:
    - "AnalysisTab displays radar chart when subject selected"
    - "Clicking topic card shows progress timeline"
    - "Timeline receives full TopicMastery object (not composite key)"
    - "Review mode banner shows after 3+ week gap"
  artifacts:
    - path: "pages/ChildDetails/AnalysisTab.tsx"
      provides: "Integrated visualization components with drill-down"
      contains: "SkillRadarChart"
    - path: "pages/ChildDetails/ReviewModeBanner.tsx"
      provides: "Welcome back banner for review mode"
      exports: ["ReviewModeBanner"]
  key_links:
    - from: "pages/ChildDetails/AnalysisTab.tsx"
      to: "pages/ChildDetails/SkillRadarChart.tsx"
      via: "Component import"
      pattern: "import.*SkillRadarChart.*from"
    - from: "pages/ChildDetails/AnalysisTab.tsx"
      to: "pages/ChildDetails/ProgressTimeline.tsx"
      via: "Component import"
      pattern: "import.*ProgressTimeline.*from"
    - from: "pages/ChildDetails/AnalysisTab.tsx"
      to: "pages/ChildDetails/ReviewModeBanner.tsx"
      via: "Component import and conditional render"
      pattern: "import.*ReviewModeBanner.*from"
---

<objective>
Integrate visualization components (radar chart, timeline) into AnalysisTab with proper data passing, and add review mode banner.

Purpose: Wire the visualization components created in Plan 05-05 into the AnalysisTab. Fix the selectedTopic state to pass the full TopicMastery object (not composite key string) to ProgressTimeline. Display "Welcome back" banner when review mode is active.

Output: AnalysisTab with integrated radar/timeline charts, proper drill-down from topic cards to timeline, and review mode indicator.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-profile-maintenance-visualization/05-RESEARCH.md

# Dependencies from earlier plans
@pages/ChildDetails/SkillRadarChart.tsx  # Plan 05
@pages/ChildDetails/ProgressTimeline.tsx  # Plan 05
@hooks/useQuizSession.ts  # Plan 03 - isReviewMode state

# File to extend
@pages/ChildDetails/AnalysisTab.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate radar chart into AnalysisTab</name>
  <files>pages/ChildDetails/AnalysisTab.tsx</files>
  <action>
Add SkillRadarChart to AnalysisTab:

1. Add import at top:
```typescript
import { SkillRadarChart } from './SkillRadarChart';
```

2. Add radar chart section after TopicMasterySection, before the grid:
```typescript
{/* Skill Radar Chart - only show if subject selected and profile exists */}
{analysisFilter !== 'all' && profile && (
  <SkillRadarChart
    profile={profile}
    subjectId={analysisFilter}
    subjectName={subjects.find(s => s.id === analysisFilter)?.name || analysisFilter}
  />
)}
```

This shows the radar chart when a specific subject is selected (not "all").
  </action>
  <verify>Run `npx tsc --noEmit` - no type errors</verify>
  <done>Radar chart displays when subject is filtered in AnalysisTab</done>
</task>

<task type="auto">
  <name>Task 2: Add timeline with proper TopicMastery passing</name>
  <files>pages/ChildDetails/AnalysisTab.tsx</files>
  <action>
Add ProgressTimeline with drill-down from topic cards:

1. Add import at top:
```typescript
import { ProgressTimeline } from './ProgressTimeline';
import { TopicMastery } from '../../types';
```

2. Add state for selected topic (using full TopicMastery object, NOT composite key string):
```typescript
// IMPORTANT: Store the full TopicMastery object, not just a string key
// This avoids lookup issues with composite keys not matching topicMastery structure
const [selectedTopic, setSelectedTopic] = useState<TopicMastery | null>(null);
```

3. Add timeline section (conditionally when topic selected):
```typescript
{/* Progress Timeline - shown when topic clicked */}
{selectedTopic && (
  <div className="mb-6">
    <div className="flex justify-between items-center mb-2">
      <h3 className="text-lg font-bold text-gray-900">מגמת התקדמות</h3>
      <button
        onClick={() => setSelectedTopic(null)}
        className="text-sm text-indigo-600 hover:text-indigo-800"
      >
        סגור
      </button>
    </div>
    <ProgressTimeline
      topic={selectedTopic.topic}
      sessions={sessions}
      currentMastery={selectedTopic}
    />
  </div>
)}
```

4. Update TopicMasteryCard to accept onSelect callback:
```typescript
interface TopicMasteryCardProps {
  mastery: TopicMastery;
  subjectName: string;
  onSelect?: () => void;  // NEW: callback for drill-down
}

// In the card's outer div, add click handler:
<div
  className={`p-4 rounded-xl border ${config.bg} ${config.border} ${onSelect ? 'cursor-pointer hover:shadow-md transition-shadow' : ''}`}
  onClick={onSelect}
  role={onSelect ? 'button' : undefined}
  tabIndex={onSelect ? 0 : undefined}
  onKeyDown={onSelect ? (e) => e.key === 'Enter' && onSelect() : undefined}
>
```

5. Pass the full TopicMastery object to setSelectedTopic (NOT a composite key):
```typescript
// In TopicMasterySection, update TopicMasteryCard usage:
<TopicMasteryCard
  key={`${topic.subjectId}-${topic.topic}`}
  mastery={topic}
  subjectName={getSubjectName(topic.subjectId)}
  onSelect={() => setSelectedTopic(topic)}  // Pass full TopicMastery object
/>
```

IMPORTANT: The key fix here is passing the full `topic` (TopicMastery) object to setSelectedTopic,
rather than a composite string like `${topic.subjectId}-${topic.topic}`.

This ensures:
- ProgressTimeline receives the actual TopicMastery object via `currentMastery` prop
- No lookup needed (which would fail because profile.topicMastery uses topic name as key, not composite key)
- Timeline has direct access to pKnown, dimensions, etc.

6. Add selectedTopic and setSelectedTopic to TopicMasterySection props:
```typescript
interface TopicMasterySectionProps {
  // ... existing props
  selectedTopic: TopicMastery | null;
  setSelectedTopic: (topic: TopicMastery | null) => void;
}
```

And pass them from AnalysisTab:
```typescript
<TopicMasterySection
  profile={profile}
  profileLoading={profileLoading}
  profileConfidence={profileConfidence}
  subjects={subjects}
  selectedSubject={analysisFilter}
  selectedTopic={selectedTopic}
  setSelectedTopic={setSelectedTopic}
/>
```
  </action>
  <verify>Run `npx tsc --noEmit` - no type errors</verify>
  <done>
Timeline integrated with proper data passing.
selectedTopic stores full TopicMastery object (not composite key).
Topic cards clickable for drill-down.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create and wire ReviewModeBanner for welcome back message</name>
  <files>pages/ChildDetails/ReviewModeBanner.tsx, pages/ChildDetails/AnalysisTab.tsx</files>
  <action>
Create a "Welcome back" banner that displays when review mode is active (3+ week gap detected).

1. **Create `pages/ChildDetails/ReviewModeBanner.tsx`:**
```typescript
import React from 'react';
import { RefreshCw } from 'lucide-react';

interface ReviewModeBannerProps {
  /** Child's name for personalized message */
  childName: string;
  /** Whether review mode is active */
  isReviewMode: boolean;
}

/**
 * Welcome back banner shown when child returns after 3+ week gap
 * Informs parents/children that quiz will include review questions
 */
export function ReviewModeBanner({ childName, isReviewMode }: ReviewModeBannerProps) {
  if (!isReviewMode) return null;

  return (
    <div
      className="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg flex items-start gap-3"
      role="status"
      aria-live="polite"
    >
      <RefreshCw className="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" />
      <div className="flex-1">
        <p className="text-blue-800 font-medium">
          ברוכה השיבה, {childName}! בואי נעשה חזרה מהירה
        </p>
        <p className="text-blue-700 text-sm mt-1">
          עברו כמה שבועות מאז התרגול האחרון. החידון הבא יכלול שאלות חזרה כדי לרענן את הזיכרון.
        </p>
      </div>
    </div>
  );
}
```

Hebrew message explanation:
- "ברוכה השיבה, {name}! בואי נעשה חזרה מהירה" = "Welcome back, {name}! Let's do a quick review"
- Second line explains: "A few weeks have passed since last practice. The next quiz will include review questions to refresh memory."

2. **Wire into `pages/ChildDetails/AnalysisTab.tsx`:**

Add import at top:
```typescript
import { ReviewModeBanner } from './ReviewModeBanner';
```

The isReviewMode state comes from useQuizSession hook (Plan 05-03), but AnalysisTab doesn't run quizzes.
Instead, we detect review mode locally using the same logic:

Add import for detection:
```typescript
import { shouldEnterReviewMode } from '../../services/adaptiveQuizService';
```

Calculate review mode in component:
```typescript
// Detect if child would be in review mode (3+ week gap)
const lastSessionTimestamp = sessions && sessions.length > 0
  ? Math.max(...sessions.filter(s => s.childId === childId).map(s => s.date))
  : null;

const isReviewMode = lastSessionTimestamp !== null && shouldEnterReviewMode(lastSessionTimestamp);
```

Render the banner at the top of AnalysisTab (before radar chart):
```typescript
{/* Review Mode Banner - shows if 3+ week gap detected */}
<ReviewModeBanner
  childName={child?.name || ''}
  isReviewMode={isReviewMode}
/>
```

The banner provides immediate feedback to parents viewing the Analysis tab that:
1. Their child hasn't practiced in a while
2. The next quiz session will include review questions
3. This is normal and intentional (not an error state)
  </action>
  <verify>
Run `npx tsc --noEmit` - no type errors

Manual verification:
- ReviewModeBanner.tsx exports ReviewModeBanner component
- AnalysisTab imports ReviewModeBanner and shouldEnterReviewMode
- Banner renders when isReviewMode is true
- Banner hidden when isReviewMode is false
- Hebrew text displays correctly (RTL)
  </verify>
  <done>
ReviewModeBanner component created with Hebrew "Welcome back" message.
Wired into AnalysisTab with review mode detection.
Banner informs parents that review questions will be included.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. AnalysisTab:
   - Radar chart shows when subject selected
   - Timeline shows when topic clicked
   - Cards are clickable for drill-down
   - selectedTopic is TopicMastery object (not string)
   - ProgressTimeline receives currentMastery prop correctly
3. ReviewModeBanner:
   - Renders blue info banner when isReviewMode is true
   - Shows personalized Hebrew message with child name
   - Hidden when isReviewMode is false
   - Accessible (role="status", aria-live)
</verification>

<success_criteria>
- Radar chart in AnalysisTab (success criteria #5)
- Timeline in AnalysisTab (success criteria #6)
- Clicking topic card shows timeline with correct mastery data
- No composite key lookup issues
- Review mode banner displays after 3+ week gap (success criteria #3)
- All components integrated without breaking existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/05-profile-maintenance-visualization/05-07-SUMMARY.md`
</output>
