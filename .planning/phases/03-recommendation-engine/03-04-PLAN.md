---
phase: 03-recommendation-engine
plan: 04
type: execute
wave: 3
depends_on: ["03-02", "03-03"]
files_modified:
  - pages/ChildDetails/RecommendationsPanel.tsx
  - pages/ChildDetails/RecommendationCard.tsx
  - pages/ChildDetails/OverrideModal.tsx
  - pages/ChildDetails/GoalForm.tsx
  - pages/ChildDetails/index.tsx
autonomous: false

must_haves:
  truths:
    - "Parent sees 3-5 recommended topics in ChildDetails dashboard"
    - "Each recommendation shows priority badge, confidence indicator, and expandable reasoning"
    - "Parent can click 'Override' to dismiss with structured rationale capture"
    - "Parent can add/view/delete learning goals for the child"
  artifacts:
    - path: "pages/ChildDetails/RecommendationsPanel.tsx"
      provides: "Main recommendations display panel"
      min_lines: 80
    - path: "pages/ChildDetails/RecommendationCard.tsx"
      provides: "Individual recommendation with expandable reasoning"
      min_lines: 100
    - path: "pages/ChildDetails/OverrideModal.tsx"
      provides: "Modal for capturing override rationale"
      min_lines: 60
    - path: "pages/ChildDetails/GoalForm.tsx"
      provides: "Form for adding learning goals"
      min_lines: 80
  key_links:
    - from: "pages/ChildDetails/RecommendationsPanel.tsx"
      to: "hooks/useRecommendations.ts"
      via: "import"
      pattern: "useRecommendations"
    - from: "pages/ChildDetails/index.tsx"
      to: "pages/ChildDetails/RecommendationsPanel.tsx"
      via: "import"
      pattern: "RecommendationsPanel"
---

<objective>
Create recommendation UI components for parent dashboard

Purpose: Display AI-powered topic recommendations to parents with full transparency (expandable reasoning, confidence indicators) and control (override capability, goal setting).

Output: RecommendationsPanel, RecommendationCard, OverrideModal, GoalForm components integrated into ChildDetails
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-recommendation-engine/03-RESEARCH.md
@.planning/phases/03-recommendation-engine/03-01-SUMMARY.md
@.planning/phases/03-recommendation-engine/03-02-SUMMARY.md
@.planning/phases/03-recommendation-engine/03-03-SUMMARY.md

# Integration point
@pages/ChildDetails/index.tsx
@pages/ChildDetails/types.ts

# UI patterns
@types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RecommendationCard component</name>
  <files>pages/ChildDetails/RecommendationCard.tsx</files>
  <action>
Create `pages/ChildDetails/RecommendationCard.tsx`:

```typescript
/**
 * RecommendationCard
 *
 * Displays a single topic recommendation with:
 * - Priority badge (urgent/important/review)
 * - Confidence indicator (low/medium/high)
 * - Expandable reasoning section
 * - Action buttons (Start Quiz, Override)
 */
```

Props interface:
```typescript
interface RecommendationCardProps {
  recommendation: Recommendation;
  onStartQuiz: (topic: string) => void;
  onOverride: () => void;  // Opens modal
}
```

Implementation:
1. **Priority badges** (Hebrew, RTL):
   - urgent: bg-red-100 text-red-800, "דחוף"
   - important: bg-yellow-100 text-yellow-800, "חשוב"
   - review: bg-green-100 text-green-800, "חיזוק"

2. **Confidence indicators**:
   - high: checkmark icon, "דיוק גבוה", text-green-600
   - medium: tilde icon, "דיוק בינוני", text-yellow-600
   - low: question mark icon, "אומדן ראשוני", text-gray-500

3. **Expandable reasoning**:
   - useState for expanded
   - ChevronDown icon rotates 180deg when expanded
   - bg-gray-50 rounded-lg p-4 for reasoning section
   - Map over recommendation.reasoning for bullet points
   - Show category in Hebrew: weakness="חיזוק חולשות", growth="צמיחה והתקדמות", maintenance="תחזוקה וביסוס"

4. **Actions**:
   - "התחל תרגול" primary button -> onStartQuiz(recommendation.topic)
   - "דחה" secondary button -> onOverride()

Use Tailwind classes matching existing ChildDetails UI patterns.
Import Target, ChevronDown from lucide-react.
  </action>
  <verify>Run `npx tsc --noEmit` - component compiles without errors</verify>
  <done>RecommendationCard displays priority, confidence, expandable reasoning, and action buttons</done>
</task>

<task type="auto">
  <name>Task 2: Create OverrideModal component</name>
  <files>pages/ChildDetails/OverrideModal.tsx</files>
  <action>
Create `pages/ChildDetails/OverrideModal.tsx`:

```typescript
/**
 * OverrideModal
 *
 * Captures parent's reason for dismissing a recommendation.
 * Structured options + optional free-text for "other".
 */
```

Props interface:
```typescript
interface OverrideModalProps {
  topic: string;
  isOpen: boolean;
  onConfirm: (reason: OverrideReason, customReason?: string) => void;
  onCancel: () => void;
}
```

Implementation:
1. **Modal overlay**: fixed inset-0 bg-black/50 flex items-center justify-center z-50
2. **Modal content**: bg-white rounded-xl p-6 max-w-md w-full mx-4
3. **Header**: "למה לדחות את ההמלצה?"
4. **Radio options** (Hebrew):
   - too_easy: "הילד/ה כבר יודע/ת את זה"
   - too_hard: "עדיין מתקדם מדי"
   - wrong_priority: "יש דברים חשובים יותר עכשיו"
   - other: "סיבה אחרת"
5. **Conditional textarea**: Show when "other" selected, placeholder "פרט/י את הסיבה..."
6. **Actions**:
   - "ביטול" secondary -> onCancel()
   - "אישור" primary -> onConfirm(selectedReason, customReason)

Guard: if !isOpen, return null.
  </action>
  <verify>Run `npx tsc --noEmit` - component compiles without errors</verify>
  <done>OverrideModal captures structured override rationale from parent</done>
</task>

<task type="auto">
  <name>Task 3: Create GoalForm component</name>
  <files>pages/ChildDetails/GoalForm.tsx</files>
  <action>
Create `pages/ChildDetails/GoalForm.tsx`:

```typescript
/**
 * GoalForm
 *
 * Allows parents to add learning goals (targets).
 * Structured input: topic dropdown + optional date + description.
 */
```

Props interface:
```typescript
interface GoalFormProps {
  childId: string;
  familyId: string;
  subject: Subject;
  existingGoals: LearningGoal[];
  onAdd: (goal: LearningGoal) => void;
  onDelete: (goalId: string) => void;
}
```

Implementation:
1. **Add Goal section**:
   - Topic dropdown: `<select>` from subject.topics, exclude topics with existing goals
   - Target date: `<input type="date">` optional
   - Description: `<textarea>` placeholder "הערות (אופציונלי)"
   - "הוסף יעד" button

2. **Existing goals list**:
   - Map over existingGoals
   - Show topic name, target date (if set), description
   - Delete button (X icon) per goal

3. **Empty state**: "אין יעדים מוגדרים" when existingGoals.length === 0

4. **Form handling**:
   - useState for topic, targetDate, description
   - handleSubmit: validate topic selected, call addLearningGoal service, onAdd callback, reset form
   - Use useStore() to get parent for createdBy

Import addLearningGoal, deleteLearningGoal from services.
  </action>
  <verify>Run `npx tsc --noEmit` - component compiles without errors</verify>
  <done>GoalForm allows adding and managing learning goals per subject</done>
</task>

<task type="auto">
  <name>Task 4: Create RecommendationsPanel and integrate into ChildDetails</name>
  <files>pages/ChildDetails/RecommendationsPanel.tsx, pages/ChildDetails/index.tsx</files>
  <action>
**Part A: Create RecommendationsPanel.tsx**

```typescript
/**
 * RecommendationsPanel
 *
 * Main container for topic recommendations in ChildDetails.
 * Shows recommendations + goals section for selected subject.
 */
```

Props interface:
```typescript
interface RecommendationsPanelProps {
  child: ChildProfile;
  subject: Subject;
}
```

Implementation:
1. **Use hooks**:
   - useRecommendations(child, subject, goals)
   - useState for goals (subscribe via subscribeToGoals in useEffect)
   - useState for override modal (selectedTopic, isOpen)

2. **Loading state**: Show spinner while isLoading

3. **Empty state**: "אין מספיק נתונים להמלצות" when recommendations.length === 0

4. **Recommendations section**:
   - Header: "המלצות ללמידה" with info icon
   - Map RecommendationCard components
   - Pass onStartQuiz (navigate to session), onOverride (open modal)

5. **Goals section** (collapsible):
   - Header: "יעדי למידה" with expand/collapse
   - GoalForm component

6. **Override modal**: OverrideModal with handleOverride -> useRecommendations.handleOverride

**Part B: Integrate into ChildDetails index.tsx**

1. Add import for RecommendationsPanel
2. Find PlanTab section (or appropriate location in the tabs)
3. Add RecommendationsPanel in the child details view:
   - Show when child and selectedSubject are defined
   - Position prominently (e.g., above or beside session history)
   - Pass child and selectedSubject props

Use existing navigation pattern for onStartQuiz:
```typescript
navigate(`/session/${child.id}/${subject.id}/${encodeURIComponent(topic)}`);
```
  </action>
  <verify>Run `npx tsc --noEmit` - no errors. Run `npm run dev`, navigate to ChildDetails, verify panel appears</verify>
  <done>RecommendationsPanel displays in ChildDetails with recommendations, goals, and override capability</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. All 4 components created: RecommendationCard, OverrideModal, GoalForm, RecommendationsPanel
3. RecommendationsPanel integrated into ChildDetails/index.tsx
4. Visual verification in dev server
</verification>

<success_criteria>
- Parent sees 3-5 recommendations when viewing a child's subject
- Each recommendation shows priority badge, confidence indicator, expandable "Why?"
- Parent can override recommendations with captured rationale
- Parent can add/delete learning goals that influence recommendations
- UI is Hebrew RTL and matches existing Tailwind styling
</success_criteria>

<output>
After completion, create `.planning/phases/03-recommendation-engine/03-04-SUMMARY.md`
</output>
