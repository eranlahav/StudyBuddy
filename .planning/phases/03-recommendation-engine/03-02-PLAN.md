---
phase: 03-recommendation-engine
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - services/goalsService.ts
  - services/index.ts
autonomous: true

must_haves:
  truths:
    - "Learning goals stored in Firestore 'learningGoals' collection"
    - "Goals can be created, listed, and deleted per child"
    - "Goals include topic, targetDate, description, and parent attribution"
  artifacts:
    - path: "services/goalsService.ts"
      provides: "Learning goals CRUD operations"
      exports: ["addLearningGoal", "getLearningGoals", "deleteLearningGoal", "subscribeToGoals"]
  key_links:
    - from: "services/goalsService.ts"
      to: "firebase/firestore"
      via: "collection, addDoc, query, where, getDocs, deleteDoc"
      pattern: "collection\\(db, 'learningGoals'\\)"
---

<objective>
Create goals service for parent-defined learning targets

Purpose: Enable parents to set learning goals (e.g., "master fractions by June") that influence recommendation scoring. Goals are stored in Firestore and factor into the 30% goal weight in recommendations.

Output: goalsService.ts with CRUD operations for learning goals
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-recommendation-engine/03-RESEARCH.md
@.planning/phases/03-recommendation-engine/03-01-SUMMARY.md

# Dependencies
@types.ts
@services/index.ts
@lib/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create goalsService.ts with CRUD operations</name>
  <files>services/goalsService.ts</files>
  <action>
Create `services/goalsService.ts` following existing service patterns (see sessionsService.ts, childrenService.ts):

```typescript
/**
 * Goals Service
 *
 * Manages parent-defined learning goals for children.
 * Goals influence recommendation scoring (30% weight).
 *
 * Collection: learningGoals
 */

import {
  collection,
  addDoc,
  getDocs,
  deleteDoc,
  doc,
  query,
  where,
  onSnapshot,
  Unsubscribe
} from 'firebase/firestore';
import { db } from '../firebaseConfig';
import { LearningGoal } from '../types';
import { logger, DatabaseError, generateId } from '../lib';
```

Implement:

1. **addLearningGoal(childId, familyId, subjectId, parentId, topic, targetDate, description)** -> Promise<LearningGoal>
   - Create LearningGoal object with generateId()
   - Add to 'learningGoals' collection
   - Log success with logger.info
   - Throw DatabaseError on failure

2. **getLearningGoals(childId)** -> Promise<LearningGoal[]>
   - Query where childId matches
   - Return array of goals
   - Throw DatabaseError on failure

3. **getGoalsBySubject(childId, subjectId)** -> Promise<LearningGoal[]>
   - Query where childId AND subjectId match
   - Return filtered goals

4. **deleteLearningGoal(goalId)** -> Promise<void>
   - Delete doc from 'learningGoals' collection
   - Log success
   - Throw DatabaseError on failure

5. **subscribeToGoals(childId, callback)** -> Unsubscribe
   - Real-time subscription for UI updates
   - Filter by childId
   - Return unsubscribe function

Error handling pattern (from existing services):
```typescript
try {
  // operation
  logger.info('goalsService: Success message', { context });
  return result;
} catch (error) {
  logger.error('goalsService: Failure message', { context }, error);
  throw new DatabaseError('User-facing message', { cause: error as Error });
}
```
  </action>
  <verify>Run `npx tsc --noEmit` - no type errors</verify>
  <done>goalsService.ts exports addLearningGoal, getLearningGoals, getGoalsBySubject, deleteLearningGoal, subscribeToGoals</done>
</task>

<task type="auto">
  <name>Task 2: Export goalsService from services/index.ts</name>
  <files>services/index.ts</files>
  <action>
Add to services/index.ts after the Recommendation Engine exports:

```typescript
// Learning Goals (Phase 3)
export {
  addLearningGoal,
  getLearningGoals,
  getGoalsBySubject,
  deleteLearningGoal,
  subscribeToGoals
} from './goalsService';
```
  </action>
  <verify>Import test: `import { addLearningGoal, getLearningGoals } from './services'` compiles</verify>
  <done>Goals service functions exported from services index</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. services/goalsService.ts exports all 5 functions
3. services/index.ts re-exports goal functions
4. Functions follow established error handling pattern (logger + DatabaseError)
</verification>

<success_criteria>
- Learning goals can be created with topic, targetDate, description
- Goals can be queried by childId and optionally subjectId
- Goals can be deleted by goalId
- Real-time subscription available for UI
- Errors logged and wrapped in DatabaseError
</success_criteria>

<output>
After completion, create `.planning/phases/03-recommendation-engine/03-02-SUMMARY.md`
</output>
