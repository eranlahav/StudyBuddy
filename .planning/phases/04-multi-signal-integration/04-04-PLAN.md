---
phase: 04-multi-signal-integration
plan: 04
type: execute
wave: 3
depends_on:
  - "04-03"
files_modified:
  - hooks/useQuizSession.ts
  - pages/ChildDetails/UploadEvaluationModal.tsx
  - pages/ChildDetails/AnalysisTab.tsx
autonomous: true

must_haves:
  truths:
    - "Quiz session tracks engagement metrics (timing, completion)"
    - "Engagement signal fires on session completion"
    - "Evaluation upload triggers profile update via processEvaluationSignal"
    - "Topic mastery display shows multi-dimensional data (accuracy, speed, consistency)"
    - "Signal source is visible in UI (last signal type indicator)"
  artifacts:
    - path: "hooks/useQuizSession.ts"
      provides: "Engagement metrics tracking and signal firing"
      contains: "processEngagementSignal"
    - path: "pages/ChildDetails/UploadEvaluationModal.tsx"
      provides: "Evaluation upload triggers profile signal"
      contains: "processEvaluationSignal"
    - path: "pages/ChildDetails/AnalysisTab.tsx"
      provides: "Multi-dimensional mastery display"
      contains: "dimensions"
  key_links:
    - from: "hooks/useQuizSession.ts"
      to: "services/signalService.ts"
      via: "processEngagementSignal call on finish"
      pattern: "processEngagementSignal"
    - from: "pages/ChildDetails/UploadEvaluationModal.tsx"
      to: "services/signalService.ts"
      via: "processEvaluationSignal call on save"
      pattern: "processEvaluationSignal"
---

<objective>
Integrate signal processing into UI components and hooks.

Purpose: Connects the signal processing infrastructure to user-facing components:
1. Quiz sessions capture and fire engagement signals
2. Evaluation uploads trigger profile updates with teacher-validated data
3. Analysis tab displays multi-dimensional mastery with signal source transparency

Output: Extended useQuizSession hook, updated UploadEvaluationModal, enhanced AnalysisTab
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-multi-signal-integration/04-RESEARCH.md

# Files to extend
@hooks/useQuizSession.ts
@pages/ChildDetails/UploadEvaluationModal.tsx
@pages/ChildDetails/AnalysisTab.tsx

# Signal service with processors
@services/signalService.ts

# Types for engagement metrics
@types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Engagement Tracking to useQuizSession</name>
  <files>hooks/useQuizSession.ts</files>
  <action>
Extend `useQuizSession.ts` to track engagement metrics and fire engagement signal on completion.

1. Add imports at top:
```typescript
import { processEngagementSignal } from '../services/signalService';
import { buildEngagementMetrics } from '../lib';
```

2. Add state for session timing after answer timing state:
```typescript
// Session timing for engagement metrics
const [sessionStartTime] = useState<number>(Date.now());
const [answerTimesMs, setAnswerTimesMs] = useState<number[]>([]);
```

3. In `handleAnswer`, track answer time in milliseconds. Find where `setUserAnswers` is called and add after it:
```typescript
// Track answer time for engagement metrics
const answerTimeMs = Date.now() - answerStartTime;
setAnswerTimesMs(prev => [...prev, answerTimeMs]);
```

4. Modify `finishSession` to fire engagement signal. Add this near the end of finishSession (after session save, inside the try block):
```typescript
// Fire engagement signal (fire-and-forget)
if (!isFinalReview) {
  const sessionEndTime = Date.now();
  const metrics = buildEngagementMetrics({
    sessionStartTime,
    sessionEndTime,
    questionsAnswered: userAnswers.length,
    questionsAvailable: questions.length,
    answerTimes: answerTimesMs,
    earlyExit: earlyEndReason !== null
  });

  // Fire-and-forget: don't await, errors handled internally
  processEngagementSignal(
    child.id,
    child.familyId,
    topic,
    subject.id,
    metrics,
    child.grade
  ).catch(() => {
    // Silently ignore - fire-and-forget
  });
}
```

5. Also fire engagement signal on early end (fatigue/frustration). In the section where `setIsFinished(true)` is called for fatigue detection (around line 525-528), add after it:
```typescript
// Fire engagement signal for early exit
const sessionEndTime = Date.now();
const metrics = buildEngagementMetrics({
  sessionStartTime,
  sessionEndTime,
  questionsAnswered: currentIndex + 1,
  questionsAvailable: questions.length,
  answerTimes: [...answerTimesMs, Date.now() - answerStartTime],
  earlyExit: true
});
processEngagementSignal(
  child.id,
  child.familyId,
  topic,
  subject.id,
  metrics,
  child.grade
).catch(() => {});
```

Do the same for frustration-based early exit (around line 540-544).

IMPORTANT: Keep existing functionality intact. Only ADD the engagement tracking.
  </action>
  <verify>Run `npx tsc --noEmit` - should compile without errors. Run `npm run dev` and complete a quiz - check console for engagement signal logs.</verify>
  <done>useQuizSession tracks answer times and fires processEngagementSignal on session completion and early exit</done>
</task>

<task type="auto">
  <name>Task 2: Wire Evaluation Signal to Upload Modal</name>
  <files>pages/ChildDetails/UploadEvaluationModal.tsx</files>
  <action>
Update `UploadEvaluationModal.tsx` to fire processEvaluationSignal when evaluation is saved.

1. Add import at top:
```typescript
import { processEvaluationSignal } from '../../services/signalService';
```

2. The modal likely has a `handleSave` or `onSave` function. Find where `addEvaluation` is called (the service that persists to Firestore).

3. After the evaluation is successfully saved (after `addEvaluation` succeeds), add:
```typescript
// Fire profile signal (fire-and-forget)
// Find the child from props or context
if (child) {
  processEvaluationSignal(evaluation, child).catch(() => {
    // Silently ignore - fire-and-forget pattern
  });
}
```

The modal should receive `child` as a prop. If it doesn't currently, the component needs `child: ChildProfile` added to its props.

4. If the modal doesn't have access to `child`, you can get it from the parent component context. Check if there's a `useStore` or similar hook that provides children. Use:
```typescript
// At component level, get child from store
const { children } = useStore();
const currentChild = children.find(c => c.id === childId);

// In save handler
if (currentChild) {
  processEvaluationSignal(evaluation, currentChild).catch(() => {});
}
```

NOTE: Read the file first to understand its current structure before making changes.
  </action>
  <verify>Run `npx tsc --noEmit` - should compile without errors. Test by uploading an evaluation and checking console for "signalService: Processing evaluation signal" log.</verify>
  <done>UploadEvaluationModal fires processEvaluationSignal after successful evaluation save</done>
</task>

<task type="auto">
  <name>Task 3: Enhance AnalysisTab with Multi-Dimensional Display</name>
  <files>pages/ChildDetails/AnalysisTab.tsx</files>
  <action>
Enhance `AnalysisTab.tsx` to display multi-dimensional mastery data and signal sources.

1. Add imports:
```typescript
import { getEngagementLabel, getEngagementColorClass } from '../../lib';
```

2. Find where topic mastery cards are rendered (likely in a map over topics). Add signal source indicator.

3. In the topic card display, add after the mastery percentage:
```tsx
{/* Signal source indicator */}
{mastery.lastSignalType && (
  <span className="text-xs text-gray-500 mr-2">
    {mastery.lastSignalType === 'evaluation' && 'ğŸ“„ ××‘×—×Ÿ'}
    {mastery.lastSignalType === 'quiz' && 'ğŸ“ ×ª×¨×’×•×œ'}
    {mastery.lastSignalType === 'engagement' && 'â±ï¸ ××¢×•×¨×‘×•×ª'}
    {mastery.lastSignalType === 'parent_note' && 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ×”×¢×¨×”'}
  </span>
)}
```

4. Add engagement level display if available:
```tsx
{mastery.lastEngagementLevel && (
  <span className={`text-xs ${getEngagementColorClass(mastery.lastEngagementLevel)}`}>
    {getEngagementLabel(mastery.lastEngagementLevel)}
  </span>
)}
```

5. Add expandable dimensions section for topics with dimension data:
```tsx
{mastery.dimensions && (
  <div className="mt-2 pt-2 border-t border-gray-100">
    <div className="text-xs text-gray-600 grid grid-cols-3 gap-2">
      <div>
        <span className="text-gray-400">×“×™×•×§:</span>{' '}
        {Math.round(mastery.dimensions.accuracy * 100)}%
      </div>
      <div>
        <span className="text-gray-400">××”×™×¨×•×ª:</span>{' '}
        {mastery.dimensions.speed >= 1 ? '××”×™×¨' : mastery.dimensions.speed >= 0.7 ? '× ×•×¨××œ×™' : '××™×˜×™'}
      </div>
      <div>
        <span className="text-gray-400">×¢×§×‘×™×•×ª:</span>{' '}
        {Math.round(mastery.dimensions.consistency * 100)}%
      </div>
    </div>
  </div>
)}
```

6. Add parent notes count if present:
```tsx
{mastery.parentNotes && mastery.parentNotes.length > 0 && (
  <div className="text-xs text-purple-600 mt-1">
    ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ {mastery.parentNotes.length} ×”×¢×¨×•×ª ×”×•×¨×™×
  </div>
)}
```

NOTE: Read the file first to understand its current structure. The exact placement depends on how topic cards are currently rendered.
  </action>
  <verify>Run `npx tsc --noEmit` - should compile without errors. Run `npm run dev` and navigate to child's Analysis tab - verify signal indicators and dimension data display correctly.</verify>
  <done>AnalysisTab displays signal source indicators, engagement levels, multi-dimensional metrics, and parent note counts</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Quiz completion fires engagement signal (check console logs)
3. Evaluation upload triggers profile update (check console for "Processing evaluation signal")
4. AnalysisTab shows signal source indicators for topics
5. Topics with dimensions data show accuracy/speed/consistency breakdown
6. Fire-and-forget pattern: UI never blocks waiting for signal processing
</verification>

<success_criteria>
- Quiz session tracks engagement metrics and fires signal on finish
- Engagement signal fires on early exit (fatigue/frustration)
- Evaluation upload triggers processEvaluationSignal
- AnalysisTab displays lastSignalType indicator per topic
- AnalysisTab displays engagement level when available
- AnalysisTab displays multi-dimensional breakdown when available
- TypeScript compiles without errors
- All signal processing is fire-and-forget (non-blocking)
</success_criteria>

<output>
After completion, create `.planning/phases/04-multi-signal-integration/04-04-SUMMARY.md`
</output>
