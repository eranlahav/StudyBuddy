---
phase: 02-profile-aware-quiz-generation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - types.ts
  - services/adaptiveQuizService.ts
  - services/index.ts
  - lib/encouragement.ts
  - lib/index.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Topics can be classified as weak/learning/mastered based on pKnown thresholds"
    - "Difficulty mixing produces 20%/50%/30% ratio of review/target/weak topics"
    - "Topic order starts easy (review) and builds to harder (weak)"
    - "Encouragement messages are available in Hebrew for early quiz endings"
  artifacts:
    - path: "types.ts"
      provides: "TopicClassification, DifficultyMix, QuestionRequest interfaces"
      contains: "TopicClassification"
    - path: "services/adaptiveQuizService.ts"
      provides: "classifyTopics, mixDifficulty, orderTopics functions"
      exports: ["classifyTopics", "mixDifficulty", "orderTopics"]
    - path: "lib/encouragement.ts"
      provides: "Hebrew encouragement messages for fatigue/frustration endings"
      exports: ["getEncouragementMessage", "FATIGUE_MESSAGES"]
  key_links:
    - from: "services/adaptiveQuizService.ts"
      to: "types.ts"
      via: "import LearnerProfile, TopicClassification"
      pattern: "import.*LearnerProfile.*from"
---

<objective>
Create the adaptive quiz service foundation with topic classification, difficulty mixing, and encouragement messages

Purpose: Enable quiz generation to adapt question distribution based on learner profile mastery levels
Output: New service with pure functions for difficulty mixing, new types for adaptive quiz, Hebrew encouragement messages
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-profile-aware-quiz-generation/02-RESEARCH.md

# Phase 1 provides LearnerProfile and TopicMastery types
@types.ts
@lib/index.ts
@services/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add adaptive quiz types to types.ts</name>
  <files>types.ts</files>
  <action>
Add new interfaces after the LEARNER PROFILE TYPES section (around line 346):

```typescript
// ==========================================
// ADAPTIVE QUIZ TYPES (Phase 2)
// ==========================================

/**
 * Classification of topics by mastery level
 * Used by adaptive quiz service for difficulty mixing
 */
export interface TopicClassification {
  weak: string[];       // pKnown < 0.5
  learning: string[];   // pKnown 0.5-0.8
  mastered: string[];   // pKnown >= 0.8
}

/**
 * Result of difficulty mixing algorithm
 * Determines which topics to include in quiz
 */
export interface DifficultyMix {
  reviewTopics: string[];    // 20% - mastered topics (spaced retrieval)
  targetTopics: string[];    // 50% - current level (learning zone)
  weakTopics: string[];      // 30% - struggling topics (capped if frustration)
  questionCount: number;     // Final count (may be less if topics exhausted)
}

/**
 * Request for generating a single profile-aware question
 * Passed to Gemini for targeted difficulty generation
 */
export interface QuestionRequest {
  topic: string;
  masteryPercentage: number;  // 0-100, from BKT pKnown * 100
  targetDifficulty: DifficultyLevel;
}
```

These types enable type-safe difficulty mixing without modifying existing types.
  </action>
  <verify>
Run `npx tsc --noEmit` - should pass with no errors related to new types.
Verify types are exported by checking types.ts contains TopicClassification interface.
  </verify>
  <done>
TopicClassification, DifficultyMix, and QuestionRequest interfaces are defined in types.ts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create adaptive quiz service</name>
  <files>services/adaptiveQuizService.ts, services/index.ts</files>
  <action>
Create `services/adaptiveQuizService.ts` with pure functions for difficulty mixing:

```typescript
/**
 * Adaptive Quiz Service
 *
 * Provides difficulty mixing and topic selection based on learner profiles.
 * Uses mastery thresholds from Phase 1 BKT implementation.
 *
 * Key algorithms:
 * - classifyTopics: Group topics by weak/learning/mastered
 * - mixDifficulty: Apply 20/50/30 ratio for review/target/weak
 * - orderTopics: Arrange questions easy-to-hard
 */

import { LearnerProfile, TopicClassification, DifficultyMix } from '../types';
import { shuffle } from '../lib';

// Mastery thresholds (from Phase 1)
const WEAK_THRESHOLD = 0.5;
const MASTERED_THRESHOLD = 0.8;

// Default difficulty ratios (from Phase 2 research)
const REVIEW_RATIO = 0.2;   // 20% mastered topics
const TARGET_RATIO = 0.5;   // 50% learning topics
const WEAK_RATIO = 0.3;     // 30% weak topics
const WEAK_RATIO_FRUSTRATED = 0.1;  // Reduced weak % when frustrated

/**
 * Classify topics based on BKT mastery levels
 *
 * Thresholds from Phase 1:
 * - Weak: < 0.5 (less than 50% probability of knowing)
 * - Learning: 0.5-0.8 (progressing but not mastered)
 * - Mastered: >= 0.8 (high confidence)
 *
 * @param profile - Child's learner profile (or null for new users)
 * @param availableTopics - Topics available for the quiz
 */
export function classifyTopics(
  profile: LearnerProfile | null,
  availableTopics: string[]
): TopicClassification {
  const weak: string[] = [];
  const learning: string[] = [];
  const mastered: string[] = [];

  for (const topic of availableTopics) {
    // New topics or no profile default to neutral (0.5 = learning)
    const mastery = profile?.topicMastery[topic];
    const pKnown = mastery?.pKnown ?? 0.5;

    if (pKnown < WEAK_THRESHOLD) {
      weak.push(topic);
    } else if (pKnown < MASTERED_THRESHOLD) {
      learning.push(topic);
    } else {
      mastered.push(topic);
    }
  }

  return { weak, learning, mastered };
}

/**
 * Apply 20/50/30 difficulty mixing strategy
 *
 * Strategy from Phase 2 context:
 * - 20% review (mastered topics) - Spaced retrieval, prevents forgetting
 * - 50% target (current level) - Zone of proximal development
 * - 30% weak topics (capped if frustrated) - Remediation
 *
 * If insufficient topics in a category, the quiz will be shorter.
 * This prevents forcing artificial difficulty.
 *
 * @param classification - Topics grouped by mastery level
 * @param totalQuestions - Desired number of questions
 * @param allowDifficultQuestions - False if frustration detected (caps weak %)
 */
export function mixDifficulty(
  classification: TopicClassification,
  totalQuestions: number,
  allowDifficultQuestions: boolean = true
): DifficultyMix {
  const { weak, learning, mastered } = classification;

  // Calculate target counts based on ratios
  const weakRatio = allowDifficultQuestions ? WEAK_RATIO : WEAK_RATIO_FRUSTRATED;
  let reviewCount = Math.round(totalQuestions * REVIEW_RATIO);
  let targetCount = Math.round(totalQuestions * TARGET_RATIO);
  let weakCount = Math.round(totalQuestions * weakRatio);

  // Adjust if total != sum due to rounding
  const sum = reviewCount + targetCount + weakCount;
  if (sum !== totalQuestions) {
    targetCount += (totalQuestions - sum);
  }

  // Sample topics (may get fewer than requested if topics exhausted)
  const reviewTopics = sampleTopics(mastered, reviewCount);
  const weakTopics = sampleTopics(weak, weakCount);

  // Allocate remaining questions to target (learning) topics
  const remaining = totalQuestions - reviewTopics.length - weakTopics.length;
  const targetTopics = sampleTopics(learning, remaining);

  // Final count may be less than requested
  const finalCount = reviewTopics.length + targetTopics.length + weakTopics.length;

  return {
    reviewTopics,
    targetTopics,
    weakTopics,
    questionCount: finalCount
  };
}

/**
 * Sample topics randomly without replacement
 * Uses Fisher-Yates shuffle for uniform distribution
 */
function sampleTopics(topics: string[], count: number): string[] {
  if (topics.length === 0) return [];
  if (count >= topics.length) return [...topics];

  const shuffled = shuffle([...topics]);
  return shuffled.slice(0, count);
}

/**
 * Order topics for progressive difficulty
 *
 * Strategy: Start easy (mastered) -> build confidence -> end with challenges
 * This ordering supports the pedagogical principle of warming up
 * before tackling difficult material.
 */
export function orderTopics(mix: DifficultyMix): string[] {
  return [
    ...mix.reviewTopics,    // Easy first (confidence boost)
    ...mix.targetTopics,    // Main learning in middle
    ...mix.weakTopics       // Challenges at end (when warmed up)
  ];
}

/**
 * Get all topics from a difficulty mix as an ordered array
 * Convenience function for quiz setup
 */
export function getOrderedTopics(mix: DifficultyMix): string[] {
  return orderTopics(mix);
}

/**
 * Check if profile has sufficient data for adaptive quiz
 * Returns true if at least 3 topics have been practiced
 */
export function hasProfileData(profile: LearnerProfile | null): boolean {
  if (!profile) return false;
  return Object.keys(profile.topicMastery).length >= 3;
}
```

Update `services/index.ts` to export the new service:

Add after existing exports:
```typescript
export * from './adaptiveQuizService';
```
  </action>
  <verify>
Run `npx tsc --noEmit` - should pass.
Check that classifyTopics, mixDifficulty, orderTopics are exported from services/index.ts.
  </verify>
  <done>
adaptiveQuizService.ts exists with classifyTopics, mixDifficulty, orderTopics functions.
All functions are re-exported from services/index.ts.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Hebrew encouragement messages module</name>
  <files>lib/encouragement.ts, lib/index.ts</files>
  <action>
Create `lib/encouragement.ts` with Hebrew messages for early quiz endings:

```typescript
/**
 * Hebrew Encouragement Messages
 *
 * Natural conversational Hebrew for Israeli children.
 * Used when quiz ends early due to fatigue or frustration.
 *
 * Guidelines:
 * - Positive framing (celebrate effort, not emphasize failure)
 * - Age-appropriate vocabulary
 * - No mention of "struggling" or "difficulty"
 */

/**
 * Messages shown when fatigue is detected
 * (fast answers + accuracy drop)
 */
export const FATIGUE_MESSAGES = [
  'עבודה מצוינת! בואו נקח הפסקה',
  'כל הכבוד! השגתם הרבה היום',
  'יפה מאוד! זמן טוב להפסקה קטנה',
  'מעולה! בואו ננוח קצת'
];

/**
 * Messages shown when frustration is detected
 * (3+ consecutive wrong on same topic)
 */
export const FRUSTRATION_MESSAGES = [
  'עבודה נהדרת! בואו ננסה משהו אחר',
  'היי, כבר תרגלתם הרבה היום',
  'מעולה! בואו נעשה הפסקה קצרה'
];

/**
 * Extended explanations for parents (shown in analytics)
 */
export const EARLY_END_EXPLANATIONS = {
  fatigue: 'זיהינו שהתשובות היו מהירות מהרגיל - לפעמים המוח צריך הפסקה קטנה.',
  frustration: 'ראינו שהחומר היה קצת מאתגר היום - נתרגל את זה שוב בפעם הבאה.',
  allTopicsBlocked: 'תרגלנו הרבה נושאים שונים היום - זה זמן מצוין להפסקה!'
} as const;

/**
 * Select random encouragement message
 *
 * @param type - 'fatigue' or 'frustration'
 * @returns Random Hebrew encouragement message
 */
export function getEncouragementMessage(type: 'fatigue' | 'frustration'): string {
  const messages = type === 'fatigue' ? FATIGUE_MESSAGES : FRUSTRATION_MESSAGES;
  return messages[Math.floor(Math.random() * messages.length)];
}

/**
 * Get parent-facing explanation for early ending
 */
export function getParentExplanation(type: keyof typeof EARLY_END_EXPLANATIONS): string {
  return EARLY_END_EXPLANATIONS[type];
}
```

Update `lib/index.ts` to export the encouragement module:

Add after existing exports:
```typescript
// Encouragement messages
export * from './encouragement';
```
  </action>
  <verify>
Run `npx tsc --noEmit` - should pass.
Check that getEncouragementMessage is exported from lib/index.ts.
  </verify>
  <done>
lib/encouragement.ts exists with Hebrew messages for fatigue and frustration.
getEncouragementMessage function is exported from lib/index.ts.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit` passes
2. New types exist in types.ts: TopicClassification, DifficultyMix, QuestionRequest
3. New service exists: services/adaptiveQuizService.ts with classifyTopics, mixDifficulty, orderTopics
4. Encouragement messages exist: lib/encouragement.ts with Hebrew messages
5. All exports re-exported from their respective index files
</verification>

<success_criteria>
- [ ] TopicClassification interface defined with weak/learning/mastered arrays
- [ ] DifficultyMix interface defined with review/target/weak topics and questionCount
- [ ] QuestionRequest interface defined with topic, masteryPercentage, targetDifficulty
- [ ] classifyTopics function correctly categorizes topics by pKnown thresholds (0.5, 0.8)
- [ ] mixDifficulty function applies 20/50/30 ratio (or 20/70/10 when frustrated)
- [ ] orderTopics function returns topics in review -> target -> weak order
- [ ] Hebrew encouragement messages available for fatigue and frustration scenarios
- [ ] All new code compiles without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-profile-aware-quiz-generation/02-01-SUMMARY.md`
</output>
